---
title: "Analisi dati VIASAT A2 (arco SENTINEL 31 Ago.-02 Ott. 2019)"
author:
- Federico Karagulian
date: "ultima versione `r format(Sys.time(), '%d %B %Y, %H:%M')`"
output:
  word_document: 
    reference_docx: word_style_FK.docx
  pdf_document: default
  html_document: default
  number_sections: true
  bookdown::word_document: default
---


*<br/><br/>*

## 1. Rete stradale

La sezione stradale lungo il tratto dell'autostrada **A2**, dove verra' installata la pesa dinamica da UNISA ed ENEA. è stata identificata dalla rete OpenStreetMap e convertita in forma di grafo digitale (**Figura 1**). Le coppie di nodi **(25844050, 1110091861)** verso la direzione di **Salerno** e la coppia di nodi **(1110091904, 3371747395)** verso la direzione di **Avellino** definiscono gli archi stradali sui quali è stato stimato il numero di passaggi ottenuti dai **Floating Car Data (FCD)** di Viasat.



```{r, echo=FALSE, fig.cap="**Figura 1**.Postazione Tratto dell'autostrada A2 ottenuta da OpenStreetMap. Archi e nodi sono stati individuati in corrispondezna della postazione scelta da UNISA per la prova su un pesa dinamica sperimentale).", out.width = '70%'}
knitr::include_graphics("D:/ENEA_CAS_WORK/SENTINEL/viasat_data/edges_A2_SENTINEL.png")
```

*<br/><br/>*


```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 1.**"}
rm(list = ls())

library(RPostgreSQL)
library(lubridate)
library(threadr)
library(stringr)
library(ggplot2)
library(dplyr)
library(openair)
library(pander)
library(ggrepel)
library(grid)
library(gridExtra)
library(broom)
library(tidyr)
library(RColorBrewer)
library(ggpmisc)
library(varhandle)
options(scipen=5)


setwd("D:/ENEA_CAS_WORK/SENTINEL/viasat_data")
```


*<br/><br/>*

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 0.**"}



# loads the PostgreSQL driver
drv <- dbDriver("PostgreSQL")

# Connection to postdev-01 server where DB with TomTom data from Gibraltar is stored

conn_HAIG <- dbConnect(drv, dbname = "HAIG_Viasat_SA",
                       host = "10.0.0.1", port = 5432,       
                       user = "postgres", password = "superuser")



#### select some dataraw.....2019
dataraw_2019 =  dbGetQuery(conn_HAIG, "
                     SELECT
                            idterm, latitude, longitude, timedate, speed,
                            grade, panel, vehtype, progressive
                          
                        FROM dataraw
                        limit 1000 ")


#### select some routecheck....2019.
routecheck_2019 =  dbGetQuery(conn_HAIG, "
                     SELECT
                            idterm, \"TRIP_ID\", idtrajectory, latitude, longitude, timedate, speed,
                            grade, panel, vehtype, progressive, path_time
                          
                        FROM routecheck_2019
                        limit 1000 ")
## sort by TRIP_ID or by idtrajectory
routecheck_2019 <- routecheck_2019 %>%
  arrange(desc(-idtrajectory))

# Caption <- paste0("**Tabella 00.** select some routecheck....2019_SALERNO.")
# set.caption(Caption)
# panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
# panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
# panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
# pander(routecheck_2019, emphasize.strong.cols = 1, missing = "")



```


*<br/><br/>*

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 0.**"}


routecheck_2019_example_car <- routecheck_2019[53:75, ]
  
  
Caption <- paste0("**Tabella 01.** select some routecheck CARS....2019_SALERNO.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(routecheck_2019_example_car, emphasize.strong.cols = 1, missing = "")



```


*<br/><br/>*

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 0.**"}


routecheck_2019_example_fleet <- routecheck_2019[924:944, ]
  
  
Caption <- paste0("**Tabella 02.** select some routecheck CAR....2019_SALERNO.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(routecheck_2019_example_fleet, emphasize.strong.cols = 1, missing = "")



```


*<br/><br/>*



```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 1.**"}
# data <- read.csv(paste0("FCD_data_speed.csv"),
#                                    header = T, sep=",")[-1]


data <- read.csv(paste0("FCD_UNISA_2017.csv"),
                                   header = T, sep=",")[-1]


COEFF_PENETR <- 3.8


data <- data %>%
  mutate(timedate = ymd_hms(timedate, tz = "UTC"))
data$timedate <- data$timedate + hours(2)

data$vehtype <- gsub(1, "auto", (data$vehtype))
data$vehtype <- gsub(2, "veicoli pesanti", (data$vehtype))

data_car <- data %>%
  filter(vehtype == 'auto')
data_fleet <- data %>%
  filter(vehtype == 'veicoli pesanti')


data$direzione <- as.factor(data$u)
data$direzione <- gsub("25844050", "--> Salerno", (data$direzione))
data$direzione <- gsub("1110091904", "<-- Avellino", (data$direzione))


mapmatching_data <- head(data[, c("idterm", "direzione", "u","v", "timedate", "length", "ref", "speed")])
names(mapmatching_data) <- c("ID veicolo","direzione", "u", "v", "timedate", "length (m)", "ref", "velocità")


Caption <- paste0("**Tabella 1.** Attributi della rete stradale OpenStreetMap associata alle traccie GPS (Viasat) di veicoli in movimento sull'autostrada A2.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(mapmatching_data, emphasize.strong.cols = 1, missing = "")

```


*<br/><br/>*

## 2. Dati Viasat


I dati Viasat sono caratterizzati dalla presenza di un identificativo anonimo del veicolo **idterm**, di un *orario* (**timedate**),  della distanza progressiva percorsa da ogni veicolo (**progressive**), dal un segnale *on/off* (**panel**) che indica se il motore è acceso o spento. Infine, viene anche riportata l'*accuratezza* del dato GPS (**grade**) il cui valore varia da *1* (piu' accurato) a *50* (meno accurato). 
I dati Viasat vengono forniti con una *time-zone* UTC, quindi la serie temporale è stata incrementata di due ore (GMT + 2) in riferimento all'ora legale in vigore in Italia durante il mese di Settembre 2017.

Abbiamo quindi analizzato un numero di **`r length(unique(data$idterm))`** veicoli che sono passati sulla sezione in esame dell'autostrada A2. Di questi veicoli, **`r length(unique(data_car$idterm))`** sono stati identificati come **automobili**, mentre **`r length(unique(data_fleet$idterm))`** sono stati identificati come **veicoli pesanti** (**Figura 2**). Quindi i veicoli pesanti rappresentanto circa il **13-14%** del dataset di dati. 


## 3. Map-matching e conteggio di passaggi

Per stabilire su quale arco un veicolo (FCD data) è transitato, abbiamo sviluppato un algoritmo di *map-matching*. L'algoritmo consiste nell'analisi di tutte le tracce GPS per singolo veicolo e dell'individuazione dei suoi viaggi in un determinato periodo temporale. Per ogni viaggio, che corrisponde ad una sequenza di traccie GPS, l'algoritmo ha individuato una possibile sequenza di nodi, e quindi di archi percorsi. 
** Tabella 1** mostra una parte rilevante dell'output di map-matching con l'indicazione del nodo di origine **u** e del nodo di destinazione **v** per ogni arco stradale ed ogni orario (**timedate**) in cui l'arco viene percorso. L'ordine dei nodi permette inoltre di determinare la direzione di marcia di ogni traccia. Infine, e' stato riportato il tipo di veicolo (automobile o veicolo pesante) da cui e' anche possible determinare la sua portata massima. Ogni coppia di nodi rappresenta il passaggio di un veicolo sopra un determianto arco. Il conteggio totale dei passaggi per tipo di veicolo e direzione di marcia si ottiene sommando il numero di volte che un arco viene attraverstato nell'intervallo temporale complessivo. 

*<br/><br/>*

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 2.**"}


# direzione <- data[, c("direzione", "u", "v", "idterm", "speed", "timedate")]

## get the DAY and HOUR (of the week) of observations
data <- data %>%
  mutate(day = wday(timedate, label=TRUE)) %>%
  mutate(hour = hour(timedate))
data$day <- as.factor((data$day))
data$hour <- as.factor((data$hour))

## resample to 1 hour
total_counts_direzione_all <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype) %>%
    summarize(count = length(idterm))

total_counts_direzione <- total_counts_direzione_all %>%
    group_by(direzione) %>%
    summarize(count_VIASAT = sum(count))

total_counts_direzione_type <- total_counts_direzione_all %>%
    group_by(direzione, vehtype) %>%
    summarize(count_VIASAT = sum(count))




# ## load ANAS data
# ### percentage of veicoli pesanti e auto (ANAS)
# counts_ANAS <- read.csv("D:/ENEA_CAS_WORK/SENTINEL/ANAS/STATS_passaggi_ANAS.csv")
# total_counts_ANAS <- counts_ANAS %>%
#   group_by(direzione) %>%
#   summarize(count_ANAS = sum(conteggi_totali))
# counts_ANAS <- counts_ANAS %>%
#   left_join(total_counts_ANAS, by = "direzione")
# counts_ANAS$fraction <- round(((counts_ANAS$conteggi_totali)/counts_ANAS$count_ANAS)*100, digits = 0)
# counts_ANAS <- counts_ANAS %>%
#   select(direzione, classi, conteggi_totali, fraction)
# names(counts_ANAS) <- c("direzione", "classi", "passaggi totali ANAS", "frazione %")
# 
# 
# 
# ## add ANAS count
# total_counts_direzione$count_ANAS <- total_counts_ANAS$count_ANAS
# total_counts_direzione$`%_VIASAT` <- (total_counts_direzione$count_VIASAT/total_counts_direzione$count_ANAS)*100
names(total_counts_direzione) <- c("direzione",  "passaggi totali VIASAT")
# total_counts_direzione$`%(VIASAT/ANAS)` <- round(total_counts_direzione$`%(VIASAT/ANAS)`, digits = 1)
# penetration = mean(total_counts_direzione$`%(VIASAT/ANAS)`)
# 
# 
# 
### percentage of veicoli pesanti e auto (VIASAT)
total_counts_direzione_type <- total_counts_direzione_type %>%
  left_join(total_counts_direzione, by = "direzione")
total_counts_direzione_type <- total_counts_direzione_type %>%
  dplyr::select(direzione, vehtype, count_VIASAT, `passaggi totali VIASAT`)
total_counts_direzione_type$fraction <- round(((total_counts_direzione_type$count_VIASAT)/total_counts_direzione_type$`passaggi totali VIASAT`)*100, digits = 0)
total_counts_direzione_type <- total_counts_direzione_type %>%
  dplyr::select(direzione, vehtype, count_VIASAT, fraction)
names(total_counts_direzione_type) <-  c("direzione", "classi", "passaggi totali VIASAT", "frazione %")




Caption <- paste0("**Tabella 2.** Numero totale di passaggi di autoveicoli sul tratto dell'autostrada A2 tra il 31/08/2017 ed il 18/09/2017.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(total_counts_direzione, emphasize.strong.cols = 1, missing = "")


```

*<br/><br/>*

Mentre le osservazioni ANAS sono riferite a conteggi in tempo reale di tutti i veicoli,i dati Viasat rappresentano solo una piccola frazione dei veicoli transitati sulla sezione stradale in esame.  
Come ripotato in **Tabella 3**, il mumero totale di passaggi di dati Viasat rappresenta circa il **3.5%** dei dati ANAS su entrambe le direzioni di marcia. Questo valore, che chiameremo coefficiente di **penetrazione**, è stato mediato su entrambe le direzioni di marcia e quindi rappresenta una stima aprossimativa della frazione di veicoli registrati dal sistema VIASAT. Ricordiamo che i dati ANAS e i dati VIASAT appartengono alla stessa **famiglia** di autoveicoli che sono transitati sul tratto di autostrada A2 nel periodo in esame. Tuttavia dobbiamo tenere presente che non tutti gli autoveicoli registrati da ANAS sono dotati di un dispositivo satellitare per il rilevamento da parte di VIASAT. Percio', e' piu' corretto identificare i veicoli VIASAT come una **sottofamiglia** di veicoli ANAS. Quindi, assumendo come numero assoluto di veicoli quello riportato da ANAS, applicando il coefficiente di penetrazione ai dati VIASAT dovremmo ottenere un numero di veicoli dello stesso ordine di grandezza di quello osservato per ANAS.

*<br/><br/>*


```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 2a.**"}


# frazione_pesanti_ANAS <- mean(counts_ANAS$`frazione %`[3:4])
# 
# Caption <- paste0("**Tabella 2a.** Rilevazioni **ANAS** per il numero totale di passaggi di auto e mezzi pesanti sul tratto dell'autostrada A2 tra il 31/08/2017 ed il 18/09/2017.")
# set.caption(Caption)
# panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
# panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
# panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
# pander(counts_ANAS, emphasize.strong.cols = 1, missing = "")


```


*<br/><br/>*



```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 2b.**"}

frazione_pesanti_VIASAT <- mean(total_counts_direzione_type$`frazione %`[2], total_counts_direzione_type$`frazione %`[4])

Caption <- paste0("**Tabella 2a.** Rilevazioni **VIASAT** per il numero totale di passaggi di auto e mezzi pesanti sul tratto dell'autostrada A2 tra il 31/08/2017 ed il 18/09/2017.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(total_counts_direzione_type, emphasize.strong.cols = 1, missing = "")


```



*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 2.** Numero di passaggi totali per classe di autoveicoli sul tratto dell'autostrada A2 (km5+004). I numeri all'interno del grafico indicano la distribuzione percentuale per classi di veicolo del numero di passaggi sulle due direzioni di marcia: --> Salerno e <-- Avellino."}


total_counts_direzione_type <- as.data.frame(total_counts_direzione_type)
categories <- as.character( unique(total_counts_direzione_type$classi))

### plot passaggi #####
#######################

q <- ggplot(data = total_counts_direzione_type,
            aes(classi, `passaggi totali VIASAT`, fill = direzione)) +
  theme_bw() +
  geom_bar(stat = "identity", position = position_stack()) +
  scale_x_discrete(limits = categories) +
  geom_text_repel(aes(label=paste0(`frazione %`, "%")), vjust=1, color="black",
            position = position_stack(0.4), size=5) +
  theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
  theme(axis.title.x = element_blank()) +
  ylab(expression(paste("numero di passaggi"))) +
  xlab(expression(paste(""))) +
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=1, ,hjust=0.5, size=14, face="bold")) +
  ggtitle("Numero di passaggi totali (31 Ago.-18 Sett. 2017)") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5))
q

````

*<br/><br/>*

L'andamento del numero di passaggi per giorno della settimana e per tipo di veicolo è riportato in **Figura 3**. Per i veicoli pesanti, i dati Viasat mostrano che i giorni di Sabato e Domenica sono quelli con il minore numero di passaggi. Questo risultato è in linea con i conteggi totali di mezzi pesanti osservato per i dati ANAS. Tuttavia, per le automobili, non è stato osservato lo stesso trend temporale tra i dati **Viasat** ed i dati **ANAS**. Questo significa che i dati Viasat per i veicoli pesanti sono più rappresentativi dei dati Viasat delle automobili se usati come alternativa ai dati ANAS. Tuttavia il trend orario del numero di passaggi (**Figura 4** e **Figura 4a**) rivela due andamenti diversi per i **giorni feriali** e **quelli festivi**. Come mostrato in **Figura 4**, durante i giorni feriali abbiamo un picco di traffico verso le ore 10:00 e verso le ore 20:00. Una situazione simile e' stata osservata con i dati ANAS anche se dobbiamo tenere in considerazione che il dato ANAS e' sicuramente piu' granulare di quello di VIASAT e quindi piu' dettagliato. L'andamento orario nei giorni festivi mostra dei picchi di traffico alle ore 14:00 (verso Salerno e Avellino) 19:00 (verso Salerno) e alle ore 21:00 (verso Avellino).


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 3.** Numero di passaggi totali per giorno della settimana e per classe di autoveicoli su un tratto dell'autostrada A2 (Salerno-Avellino). I numeri all'interno del grafico indicano la distribuzione percentuale per classi di veicolo del numero di passaggi."}

###############################
### summary stats by day ######
###############################


## get the months of observations
data$month <- format(data$timedate, format = "%b")

## get the DAY and HOUR (of the week) of observations
data <- data %>%
  mutate(day = wday(timedate, label=TRUE)) %>%
  mutate(hour = hour(timedate))
data$day <- as.factor((data$day))
data$hour <- as.factor((data$hour))

## resample to 1 hour
VIASAT_STATS_passaggi_daily <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype) %>%
    summarize(count = length(idterm))

VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
mutate(day = wday(Date, label=TRUE)) %>%
  mutate(hour = hour(Date))
VIASAT_STATS_passaggi_daily$day <- as.factor((VIASAT_STATS_passaggi_daily$day))
VIASAT_STATS_passaggi_daily$hour <- as.factor((VIASAT_STATS_passaggi_daily$hour))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  group_by(direzione,
           vehtype,
           day, hour) %>%
  summarise(conteggi_per_tipo = mean(count, na.rm = TRUE))

VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  group_by(direzione,
           vehtype,
           day) %>%
  summarise(conteggi_per_tipo = sum(conteggi_per_tipo, na.rm = TRUE))



### for the whole vehycles
## resample to 1 hour
all_vehtype <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione) %>%
    summarize(count = length(idterm))

all_vehtype <- all_vehtype %>%
mutate(day = wday(Date, label=TRUE)) %>%
  mutate(hour = hour(Date))
all_vehtype$day <- as.factor((all_vehtype$day))
all_vehtype$hour <- as.factor((all_vehtype$hour))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
all_vehtype <- all_vehtype %>%
  group_by(direzione,
           day, hour) %>%
  summarise(conteggi_totali = mean(count, na.rm = TRUE))

all_vehtype <- all_vehtype %>%
  group_by(direzione,
           day) %>%
  summarise(conteggi_totali = sum(conteggi_totali, na.rm = TRUE))




VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  left_join(all_vehtype, by = c("direzione", "day"))

VIASAT_STATS_passaggi_daily <- as.data.frame(VIASAT_STATS_passaggi_daily)
## get number all all vehicles by pecentage
# normalize all "passaggi" to the conteggi_totali
VIASAT_STATS_passaggi_daily$norm_conteggi <- (VIASAT_STATS_passaggi_daily$conteggi_per_tipo/VIASAT_STATS_passaggi_daily$conteggi_totali)*100

VIASAT_STATS_passaggi_daily$norm_conteggi <- round(VIASAT_STATS_passaggi_daily$norm_conteggi, digits = 0)


VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily[order(-VIASAT_STATS_passaggi_daily$conteggi_totali),]

VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily[order(-VIASAT_STATS_passaggi_daily$norm_conteggi),]


VIASAT_STATS_passaggi_daily <- as.data.frame(VIASAT_STATS_passaggi_daily)
# VIASAT_STATS_passaggi_daily$classi <- as.character(VIASAT_STATS_passaggi_daily$classi)

categories <- as.character( unique(VIASAT_STATS_passaggi_daily$vehtype))

###################################################
### plot passaggi by % pecentage and by DAY #######
###################################################

## correct percentages
VIASAT_STATS_passaggi_daily$norm_conteggi[VIASAT_STATS_passaggi_daily$vehtype == "veicoli pesanti"] <-  rev(100 - VIASAT_STATS_passaggi_daily$norm_conteggi[VIASAT_STATS_passaggi_daily$vehtype == "auto"])

mean_VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  group_by(vehtype) %>%
  summarise(mean = mean(conteggi_per_tipo, na.rm = T))

#### rescale to ANAS data
mean_passaggi_daily_pesanti <- ((mean_VIASAT_STATS_passaggi_daily$mean[2])*100)/COEFF_PENETR  # 3.8


p <- ggplot(data = VIASAT_STATS_passaggi_daily,
              aes(day, conteggi_per_tipo, fill = day)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    # facet_wrap( ~ vehtype, ncol = 4) +
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    ylim(0, 1000) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=11)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=45, vjust=1, size=12)) +
    geom_text(aes(label = paste(norm_conteggi, "%")), size = 4, hjust = 0.5,  vjust = -0.5) +
    ggtitle("Numero totale di passaggi per giorno della settimana (VIASAT, 31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 4.** Numero di passaggi orari nei giorni feriali per classe di autoveicoli su un tratto dell'autostrada A2 (Salerno-Avellino)."}

################################
### summary stats by hour ######
################################


## resample to 1 hour
VIASAT_STATS_passaggi_hourly_feriali <- data %>%
   filter(!day %in% c("sab", "dom")) %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype) %>%
    summarize(count = length(idterm))

VIASAT_STATS_passaggi_hourly_feriali <- VIASAT_STATS_passaggi_hourly_feriali %>%
mutate(day = wday(Date, label=TRUE)) %>%
  mutate(hour = hour(Date))
VIASAT_STATS_passaggi_hourly_feriali$day <- as.factor((VIASAT_STATS_passaggi_hourly_feriali$day))
VIASAT_STATS_passaggi_hourly_feriali$hour <- as.factor((VIASAT_STATS_passaggi_hourly_feriali$hour))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
VIASAT_STATS_passaggi_hourly_feriali <- VIASAT_STATS_passaggi_hourly_feriali %>%
  group_by(direzione,
           vehtype,
           hour) %>%
  summarise(conteggi_totali = mean(count, na.rm = TRUE))



VIASAT_STATS_passaggi_hourly_feriali <- as.data.frame(VIASAT_STATS_passaggi_hourly_feriali)
 
VIASAT_STATS_passaggi_hourly_feriali <- VIASAT_STATS_passaggi_hourly_feriali[order(-VIASAT_STATS_passaggi_hourly_feriali$conteggi_totali),]


VIASAT_STATS_passaggi_hourly_feriali$hour <- unfactor(VIASAT_STATS_passaggi_hourly_feriali$hour)
VIASAT_STATS_passaggi_hourly_feriali$hour <- as.numeric(VIASAT_STATS_passaggi_hourly_feriali$hour)

#### plot

# VIASAT_STATS_passaggi_hourly_SALERNO <- VIASAT_STATS_passaggi_hourly %>%
#    filter(direzione == "--> Salerno") 

p <- ggplot(data = VIASAT_STATS_passaggi_hourly_feriali,
              aes(hour, conteggi_totali, fill = hour)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    # facet_wrap( ~ vehtype, ncol = 4) +  
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    ylim(0,90) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    xlab(expression(paste(""))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("Numero totale di passaggi orari nei giorni feriali (31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```


*<br/><br/>*




````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 4a.** Numero di passaggi orari nei giorni festivi per classe di autoveicoli su un tratto dell'autostrada A2 (Salerno-Avellino)."}

################################
### summary stats by hour ######
################################


## resample to 1 hour
VIASAT_STATS_passaggi_hourly_festivi <- data %>%
   filter(day %in% c("sab", "dom")) %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype) %>%
    summarize(count = length(idterm))

VIASAT_STATS_passaggi_hourly_festivi <- VIASAT_STATS_passaggi_hourly_festivi %>%
mutate(day = wday(Date, label=TRUE)) %>%
  mutate(hour = hour(Date))
VIASAT_STATS_passaggi_hourly_festivi$day <- as.factor((VIASAT_STATS_passaggi_hourly_festivi$day))
VIASAT_STATS_passaggi_hourly_festivi$hour <- as.factor((VIASAT_STATS_passaggi_hourly_festivi$hour))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
VIASAT_STATS_passaggi_hourly_festivi <- VIASAT_STATS_passaggi_hourly_festivi %>%
  group_by(direzione,
           vehtype,
           hour) %>%
  summarise(conteggi_totali = mean(count, na.rm = TRUE))



VIASAT_STATS_passaggi_hourly_festivi <- as.data.frame(VIASAT_STATS_passaggi_hourly_festivi)
 
VIASAT_STATS_passaggi_hourly_festivi <- VIASAT_STATS_passaggi_hourly_festivi[order(-VIASAT_STATS_passaggi_hourly_festivi$conteggi_totali),]

VIASAT_STATS_passaggi_hourly_festivi$hour <- unfactor(VIASAT_STATS_passaggi_hourly_festivi$hour)
VIASAT_STATS_passaggi_hourly_festivi$hour <- as.numeric(VIASAT_STATS_passaggi_hourly_festivi$hour)

#### plot



p <- ggplot(data = VIASAT_STATS_passaggi_hourly_festivi,
              aes(hour, conteggi_totali, fill = hour)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    # facet_wrap( ~ vehtype, ncol = 4) +  
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    ylim(0, 90) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    xlab(expression(paste(""))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("Numero totale di passaggi orari nei giorni festivi (31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```




*<br/><br/>*

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Figura S3**. Andamento del numero medio orario di passaggi di autoveicoli ssu un tratto dell'autostrada A2 (Salerno-Avellino lungo la sezione ANAS 671 (A2, Km 5+004), 31 Ago. - 17 Sett 2017). L'andamento è riportato per le due direzioni di marcia, Ascendente e Discendente."}


### joined data (feriali + festivi)


#### rescale to ANAS data
VIASAT_STATS_passaggi_hourly_feriali$conteggi_totali <- round(((VIASAT_STATS_passaggi_hourly_feriali$conteggi_totali)*100)/COEFF_PENETR, digits = 0)  
VIASAT_STATS_passaggi_hourly_festivi$conteggi_totali <- round(((VIASAT_STATS_passaggi_hourly_festivi$conteggi_totali)*100)/COEFF_PENETR, digits = 0) 


joined_VIASAT_STATS_passaggi_hourly <- VIASAT_STATS_passaggi_hourly_feriali %>%
  left_join(VIASAT_STATS_passaggi_hourly_festivi, by = c("hour", "direzione", "vehtype"))


## rename "counts" columns
names(joined_VIASAT_STATS_passaggi_hourly)[names(joined_VIASAT_STATS_passaggi_hourly) == 'conteggi_totali.x'] <- 'conteggi_totali_feriali'

names(joined_VIASAT_STATS_passaggi_hourly)[names(joined_VIASAT_STATS_passaggi_hourly) == 'conteggi_totali.y'] <- 'conteggi_totali_festivi'


df <- joined_VIASAT_STATS_passaggi_hourly %>%
  dplyr::select(hour, direzione, vehtype, conteggi_totali_feriali, conteggi_totali_festivi) %>%
  gather(key = "variable", value = "value", - c(hour, direzione, vehtype) )

df <- as.data.frame(df)



#####################
#### line plot ###
#####################

p <- ggplot(df, aes(x = hour, y = value)) + 
    geom_line(aes(color = variable, linetype = variable), lwd=1) + 
    # facet_wrap( ~ direzione, ncol = 4) +
   # facet_grid(vehtype ~ direzione, scales = "free", space = "free") +
    facet_grid(vehtype ~ direzione) +
    theme_bw() +
    scale_color_manual( values = c("black", "red")) +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=12)) +
    theme(axis.text.x=element_text(size=12, colour = "black")) +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
    xlab("ora") +
    ylab("numero di passaggi") +
     theme(axis.title.x = element_text(face="bold", colour="black", size=11),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=11, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    ggtitle("Numero totale di passaggi orari nei giorni feriali e festivi (31 Ago.-18 Sett. 2017)") + 
    scale_x_continuous(breaks=c(0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24)) +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 11))
p



```





*<br/><br/>*

Dall'analisi dei valori di portata massima dei veicoli pesanti è stato osservato un valore minimio di 1180 kg ed un valore massimo di 39000 kg. Tuttavia, come illustrato in **Figura 5** e **Figura 6**, circa il 55% dei veicoli pesanti transitati sull'autostrada A2 ha una portata massima di **18000 kg** seguito dall'11% e dal 7.5% di transiti con veicoli con portata di **3500 kg** e **26000 kg**, rispettivamente. Quindi il maggior numero d veicoli pesanti transitati, appartiene alla categoria dei veicoli a 2 assi da 18 tonnellate (motocarri) seguita da veicoli a 3 assi da 26 tonnellate (autoreni). Tuttavia e' stato rilevato anche un numero consistente di furgono commerciali a due assi dalla portata di 3.5 tonnellate. 


*<br/><br/>*



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=6,  fig.cap ="**Figura 5.** Passaggi di veicoli pesanti in relazione alla *portata* su un tratto dell'autostrada A2 (Salerno-Avellino)."}
 
########################################
### PORTATA per VEICOLI PESANTI  #######
########################################


portata_veh <- data %>%
  filter(vehtype == "veicoli pesanti")
## skip NA values
portata_veh <- portata_veh[!is.na(portata_veh["portata"]),]

portata_raw <- portata_veh

## resample to 1 hour and group by portata
portata_veh <- portata_veh %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, portata, speed) %>%
    summarize(count = length(idterm))
  

portata_veh <- portata_veh %>%
mutate(day = wday(Date, label=TRUE)) %>%
  mutate(hour = hour(Date))
portata_veh$day <- as.factor((portata_veh$day))
portata_veh$hour <- as.factor((portata_veh$hour))



###############################################
### LIMITI velocita' mezzi pesanti  ###########
###############################################


### function to estimate the excedances of speed limits based on speeds and portata
### portata is expressed in units of Kg
limits_pesanti_fun <- function(portata, speed){
  ## autostrade
   if ((portata >= 12000) & (speed > 80))
    OVER_LIMIT = "YES"
   else if ((portata < 12000) & (portata >= 350) & (speed > 100))
    OVER_LIMIT = "YES"


  else OVER_LIMIT = "NO"

  return(OVER_LIMIT)
}


portata = portata_veh$portata
speed = portata_veh$speed

## get excedances of speed limits
over_limit = NULL
for (i in 1:nrow(portata_veh)) {
  # print(paste(c("==========", i)))
  OVER_LIMIT = limits_pesanti_fun(portata[i], speed[i])
  # print(OVER_LIMIT)
  over_limit = rbind(over_limit, OVER_LIMIT)
}

OVER_LIMIT <- as.data.frame(over_limit)
rownames(OVER_LIMIT) <- NULL
names(OVER_LIMIT) <- "superamento lim. velocità"
portata_veh <- cbind(portata_veh, OVER_LIMIT)


superamenti <- portata_veh %>%
  group_by(direzione, portata) %>%
  filter(`superamento lim. velocità` == "YES") %>%
  summarize(count_superamenti = length(`superamento lim. velocità`))

#############################################################
#### using raw data #########################################

portata = portata_raw$portata
speed = portata_raw$speed

## get excedances of speed limits
over_limit = NULL
for (i in 1:nrow(portata_raw)) {
  # print(paste(c("==========", i)))
  OVER_LIMIT = limits_pesanti_fun(portata[i], speed[i])
  # print(OVER_LIMIT)
  over_limit = rbind(over_limit, OVER_LIMIT)
}

OVER_LIMIT <- as.data.frame(over_limit)
rownames(OVER_LIMIT) <- NULL
names(OVER_LIMIT) <- "superamento lim. velocità"
portata_raw <- cbind(portata_raw, OVER_LIMIT)


superamenti_raw <- portata_raw %>%
  group_by(direzione, portata) %>%
  filter(`superamento lim. velocità` == "YES") 


##############################################################
##############################################################


min_portata <- min(portata_veh$portata)
max_portata <- max(portata_veh$portata)


portata_veh <- portata_veh %>%
  group_by(portata,
           direzione) %>%
  summarise(conteggi = sum(count, na.rm = TRUE))

all_portata_veh <- portata_veh %>%
  group_by(direzione) %>%
  summarize(total = sum(conteggi))

portata_veh <- portata_veh %>%
  left_join(all_portata_veh, by = "direzione")


portata_veh <- as.data.frame(portata_veh)
portata_veh <- portata_veh %>%
  group_by(direzione) %>%
  mutate(percentage = round(((conteggi)/(total))*100, digits = 1))


# portata_veh$percentage <- round(((portata_veh$conteggi)/(all_portata_veh$total))*100, digits = 1)


p <- ggplot(data = portata_veh, 
            aes(portata, conteggi, fill = portata)) +
  theme_bw() +
  geom_line(alpha=1, col="red", size = 1, linetype="dashed") +
  stat_peaks(colour = "red", span = 21, ignore_threshold = 0.5) +
  stat_peaks(geom = "text", colour = "blue", vjust = -0.5, size = 4, x.label.fmt = "%04d",
             span = 5, ignore_threshold = 0.05) +
  geom_point(alpha=1, col="black", size = 1) +
  facet_wrap( ~ direzione, ncol = 4) +
  guides(fill=FALSE) +
  theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=13)) +
  theme(axis.text.x=element_text(size=13, colour = "black")) +
  theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
  # theme(axis.title.x = element_blank()) +  
  xlab("portata (kg)") +
  ylab("conteggi") +   
     # geom_text(aes(label = paste(percentage, sep = "")), size = 3, hjust = 0.5,  vjust = -0.5) +
 # ylim(0, 1200) +
   theme(axis.title.y = element_text(face="bold", colour="black", size=13),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
  ggtitle("Passaggi di veicoli pesanti per valore della loro portata (in kg) (31 Ago.-18 Sett. 2017)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
# q




# library(scales) 
# 
# ### get values from geom_density()
# m <- ggplot(portata_raw, aes(x = portata))
# m <- m + geom_density()
# p <- ggplot_build(m)  
# max_density <- max(p$data[[1]]$density)
# max_percentage <- 100
# data_dens <- p$data[[1]]

  
# q <- ggplot(data = data_dens, 
#             aes(x, ndensity)) +
#   theme_bw() +
#   geom_line(alpha=1, col="red", size = 1, linetype="dashed") +
#   stat_peaks(colour = "red", span = 21, ignore_threshold = 0.5) +
#   stat_peaks(geom = "text", colour = "blue", vjust = -0.5, size = 4, x.label.fmt = "%04d",
#              span = 5, ignore_threshold = 0.05) +
#   geom_point(alpha=1, col="black", size = 1) +
#   # facet_wrap( ~ direzione, ncol = 4) +
#   guides(fill=FALSE) +
#   theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=10)) +
#   theme(axis.text.x=element_text(size=10, colour = "black")) +
#   theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
#   # theme(axis.title.x = element_blank()) +  
#   xlab("portata (kg)") +
#   ylab("conteggi") +   
#      # geom_text(aes(label = paste(percentage, sep = "")), size = 3, hjust = 0.5,  vjust = -0.5) +
#  # ylim(0, 1200) +
#    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
#         axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
#   ggtitle("Passaggi di veicoli pesanti per valore della loro portata (in kg) (31 Ago.-02 Ott. 2019)") + 
#   theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
# q

  

# breaks_density <- seq(0, max_density, by = 0.00001)
# breaks_perc <- round((breaks_density*max_percentage)/max_density, digits = 0)
# 
# 
# p <- ggplot(portata_raw, aes(x=portata)) +
#   geom_density(position="identity") +
#   scale_y_continuous(breaks = breaks_density,
#        labels = c(paste0(breaks_perc, "%")) ) +
#   facet_wrap( ~ direzione, ncol = 4) +
#     theme_bw() +
#     guides(fill=FALSE) +
#     theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=10)) +
#     theme(axis.text.x=element_text(size=10, colour = "black")) +
#     theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
#     # theme(axis.title.x = element_blank()) +  
#     xlab("portata (kg)") +
#     ylab("conteggi") +   
#      # geom_vline(xintercept = 3500, col="red", lty=1, size=1) +
#      geom_text(aes(x = 3000 , y = 0.00007 , label = "3500"), size = 4) +
#      # geom_vline(xintercept = 18000, col="blue", lty=1, size=1) +
#      geom_text(aes(x = 15000 , y = 0.0001 , label = "18000"), size = 4) +
#      theme(axis.title.y = element_text(face="bold", colour="black", size=13),
#           axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
#     ggtitle("Passaggi di veicoli pesanti per valore della loro portata (in kg) (31 Ago.-02 Ott. 2019)") + 
#     theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
# p




### get only vehicles with percetnage >1%
portata_veh <- portata_veh %>%
  filter(percentage > 1.3)

AAA <- portata_veh %>%
  group_by(direzione) %>%
  summarize(somma = sum(percentage))
# mean(AAA$somma)


# file:///C:/Users/karaf/Downloads/la_classificazione_delle_strade_ed_i_livelli_di_servizio.pdf
# http://www.triesteprima.it/motori/veicoli-commerciali/mezzi-pesanti-regole-e-limiti-di-velocita.html

portata_veh <- portata_veh %>%
  group_by(direzione) %>%
  mutate(portata = factor(portata, levels = portata[order(conteggi)]))


#### histograms

q <- ggplot(data = portata_raw, 
            aes(portata, fill = direzione)) +
  theme_bw() +
   geom_histogram(bins = 50) +
 facet_wrap( ~ direzione, ncol = 2) +
   theme( strip.text = element_text(size = 13)) +
  guides(fill=FALSE) +
  theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=13)) +
  theme(axis.text.x=element_text(size=13, colour = "black")) +
  theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
  xlab("portata (kg)") +
  ylab("conteggi") +   
  geom_text(aes(x = 13000 , y = 700 , label = "18000"), size = 5) +
  geom_text(aes(x = 6200 , y = 250 , label = "3500"), size = 5) +
  geom_text(aes(x = 29000 , y = 220 , label = "26000"), size = 5) +
  theme(axis.title.y = element_text(face="bold", colour="black", size=13),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
  ggtitle("Passaggi di veicoli pesanti per valore della loro portata (in kg) (31 Ago.-18 Sett. 2017)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
q



```


*<br/><br/>*



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 5a.**Percentuale di passaggi per classe di portata riferito ai veicoli pesanti."}

######################################################
### superamenti limite velocità veicoli pesanti ######
######################################################

superamenti <- as.data.frame(superamenti)
superamenti$portata <- as.factor(superamenti$portata)


all_superamenti <- superamenti%>%
  group_by(direzione) %>%
  summarize(all_superamenti = sum(count_superamenti))
tutti_superamenti <- sum(all_superamenti$all_superamenti)
# all_portata_veh$total


summary_superamenti <- cbind(all_portata_veh$total, all_superamenti)
names(summary_superamenti) <- c("passaggi", "direzione", "superamenti")
summary_superamenti <- summary_superamenti %>%
  mutate(no_superamenti = passaggi- superamenti)
summary_superamenti <- summary_superamenti %>%
  mutate(perc_superamenti = round( (superamenti/passaggi)*100, digits = 0))

tutti_passaggi <- sum(summary_superamenti$passaggi)


# all_NO_superamenti <- all_portata_veh$total - all_superamenti

count_superamenti <- data.frame(veicoli_pesanti = c(summary_superamenti$no_superamenti,        
                                                    summary_superamenti$superamenti), 
                                direzione = c("--> Salerno", "<-- Avellino ", 
                                              "--> Salerno", "<-- Avellino "),
                                superamenti =c("","", "superamenti",  "superamenti"),
                                perc_superamenti = c(" ", " ",
                                                     paste0(summary_superamenti$perc_superamenti, "%")))


count_superamenti$classi <- "veicoli pesanti"

perc_superamenti <- round((sum(as.numeric(summary_superamenti$perc_superamenti[1]), as.numeric(summary_superamenti$perc_superamenti[2]) ))/2, digits = 0)

categories <- as.character( unique(count_superamenti$classi))



### plot passaggi #####
#######################





### plot passaggi #####
#######################
library(scales)

portata_veh <- as.data.frame(portata_veh)
portata_veh$direzione <- as.factor(portata_veh$direzione)

portata_veh$classi <- "veicoli pesanti"
names(portata_veh)[names(portata_veh) == 'portata'] <- 'portata (kg)'

perc_superamenti_Salerno <- summary_superamenti$perc_superamenti[1]
perc_superamenti_Avellino <- summary_superamenti$perc_superamenti[2]



portata_veh <- portata_veh %>% 
  group_by(direzione) %>%
  arrange(desc(`portata (kg)`)) %>%
  mutate(prop = conteggi / sum(portata_veh$conteggi) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop )

AAA <- portata_veh %>%
  dplyr::filter(direzione == "<-- Avellino")


AAA <- portata_veh %>%
  dplyr::filter(direzione == "--> Salerno")

bp <- ggplot(portata_veh, aes(x="", y=prop, fill=`portata (kg)`)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0)  +
  theme_void() + 
  # theme(legend.position="none") +
   theme(axis.text.x=element_blank())+
   facet_wrap( ~ direzione, ncol = 4) +
  theme(strip.text = element_text(size = 13)) +
  # scale_fill_brewer("Blues") +
  ggtitle("                                              80% dei passaggi per portata e per direzione") +
  geom_text(aes(y = ypos, label = percentage), color = "black", size=4) +
    scale_fill_brewer(palette="Set3")
bp




 
# portata_veh <- as.data.frame(portata_veh)
# portata_veh$direzione <- as.factor(portata_veh$direzione)
# 
# portata_veh$classi <- "veicoli pesanti"
# names(portata_veh)[names(portata_veh) == 'portata'] <- 'portata (kg)'
# 
# perc_superamenti_Salerno <- summary_superamenti$perc_superamenti[1]
# perc_superamenti_Avellino <- summary_superamenti$perc_superamenti[2]
# 
# q1 <- ggplot(data = portata_veh,
#             aes(direzione, conteggi, fill = `portata (kg)`)) +
#   theme_bw() +
#   geom_bar(stat = "identity", position = position_stack()) +
#   # facet_wrap( ~ direzione, ncol = 4) +
#    # guides(fill=FALSE)
#   # scale_x_discrete(limits = categories) +
#   geom_text_repel(aes(label=paste0(percentage, "%")), vjust=1, color="black",
#             position = position_stack(0.4), size=4) +
#   theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
#   theme(axis.title.x = element_blank()) +
#   ylab(expression(paste("numero di passaggi"))) +
#   xlab(expression(paste(""))) +
#   theme(axis.title.y = element_text(face="bold", colour="black", size=12),
#         axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
#   theme(axis.title.x = element_text(face="bold", colour="black", size=13),
#           axis.text.x  = element_text(angle=0, vjust=1, ,hjust=0.5, size=14, face="bold")) +
#  # ggtitle("Numero totale di passaggi di veicoli pesanti (1-18 Sett. 2017)") +
#   theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5))
# q1

  
```  


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 5b.** Numero totale di superamenti dei limiti di velocità in vigore per i veicoli pesanti."}

q2 <- ggplot(data = count_superamenti,
            aes(direzione, veicoli_pesanti, fill = veicoli_pesanti)) +
  theme_bw() +
  geom_bar(stat = "identity", position = position_stack()) +
  guides(fill=FALSE) +
  # scale_x_discrete(limits = categories) +
  geom_text_repel(aes(label=perc_superamenti), vjust=1, color="white",
            position = position_stack(0.4), size=5) +
  theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
  theme(axis.title.x = element_blank()) +
  ylab(expression(paste("numero di passaggi"))) +
  xlab(expression(paste(""))) +
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=1, ,hjust=0.5, size=14, face="bold")) +
ggtitle("superamenti limite velocità (100% dei passaggi)") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5))
q2



# ### final layout
# grid.arrange(q1, q2, nrow=1, ncol = 2,
#              top = textGrob("              80% dei passaggi per portata                                           superamenti limite velocità (100% dei passaggi)",gp=gpar(fontsize=13,font=3)))




```



*<br/><br/>*

**Figura 5a** (sinistra) e' una rappresentazione piu' concisa riferita ad una frazione di passaggi di veicoli pesanti attribuiti alle classi di portata con il maggior numero di passaggi. Come si vede, la classe di portata piu' alta e' quella di 18 tonnellate, seguita da quella di 3.5 e 26 tonnellate. E' stato interessante valutare il numero di superamenti dei limiti di velocita' in vigore per i veicoli pesanti sulle autostrade. Ricordiamo che per i veicoli con portata maggiore di 12 tonnellate, il limite massimo consentito e' di **80 km/h**. Invece per veicoli di portata inveriore a 12 tonnellate ma maggiore od uguale a 3.5 tonnellalte, il limite e' di **100 km/h**. Il maggior mumero di superamenti e' stato osservato per i veicoli di 18t, 26t e 3.5t con un totale di **`r tutti_superamenti`** superamenti (su un totale di **`r tutti_passaggi`** passggi). Quindi circa il **`r perc_superamenti`%** dei veicoli pesanti ha superato il limite di velocita' consentito. Come mostrato in **Figura 5** e **Figura 5a**, il numero di passaggi di veicoli pesanti è stato osservato essere più grande nella direzione verso Salerno. Anche il numero di passaggi di veicoli con portata di 18 tonnellate è stato di di frequenza maggiore nella direzione di Salerno (57%) piuttosto che nella direzione di Avellino (53%). Il caso contrario è stato osservato per i veicoli commerciali di 3.5 tonnellate che hanno registrato una frequenza del 9.6% verso Avellino ed una frequenza del 7.9% verso Salerno.

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=6,  fig.cap ="**Figura 5b.** Numero di superamenti dei limiti di velocità in relazione alla portata."}

########################################
### SUPERAMENTI LIMITI VELOCITA'  ######
########################################

# superamenti_by_portata <- superamenti %>%
#   group_by(portata, direzione) %>%
#   summarize(count_superamenti=sum(count_superamenti))
# 
# superamenti_by_portata <- as.data.frame(superamenti_by_portata)
# superamenti_by_portata$portata <- unfactor(superamenti_by_portata$portata)
# 
# 
# q <- ggplot(data = superamenti_by_portata,
#             aes(portata, count_superamenti)) +
#   theme_bw() +
#   geom_line(alpha=1, col="red", size = 1, linetype="dashed") +
#   stat_peaks(colour = "red", span = 21, ignore_threshold = 0.5) +
#   stat_peaks(geom = "text", colour = "blue", vjust = -0.5, size = 4, x.label.fmt = "%04d",
#              span = 5, ignore_threshold = 0.05) +
#   geom_point(alpha=1, col="black", size = 2) +
#   facet_wrap( ~ direzione, ncol = 4) +
#   guides(fill=FALSE) +
#   theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=10)) +
#   theme(axis.text.x=element_text(size=10, colour = "black")) +
#   theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
#   # theme(axis.title.x = element_blank()) +
#   xlab("portata (kg)") +
#   ylab("conteggi") +
#      # geom_text(aes(label = paste(percentage, sep = "")), size = 3, hjust = 0.5,  vjust = -0.5) +
#   # ylim(0, 350) +
#    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
#         axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
#   ggtitle("Numero di superamenti limite velocità per portata (in kg) (31 Ago.-02 Ott. 2019)") +
#   theme(plot.title = element_text(lineheight=.8, face="bold", size = 15))
# q



#### histograms

p <- ggplot(superamenti_raw, aes(x=portata, fill=direzione)) +
     geom_histogram() +
     theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    # geom_density(stat = 'bin') +
    theme(legend.title=element_blank()) + 
    aes(y=stat(count)/sum(stat(count))) + 
    scale_y_continuous(labels = scales::percent) +
    facet_wrap( ~ direzione, ncol = 2) +
    guides(fill=FALSE) +
    theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=12)) +
    theme(axis.text.x=element_text(size=12, colour = "black")) +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13)) +
    xlab("portata (kg)") +
    ylab("conteggi/totale conteggi (%)") +
    geom_text(aes(x = 13000 , y = 0.15 , label = "18000"), size = 5) +
    geom_text(aes(x = 7200 , y = 0.02 , label = "3500"), size = 5) +
    geom_text(aes(x = 30000 , y = 0.05 , label = "26000"), size = 5) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
    ggtitle("Numero di superamenti limite velocità per portata (in kg) (31 Ago.-18 Sett. 2017)") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
p




```


*<br/><br/>*


 **Figura 5a** (destra) e  **Figura 5b** mostrano l'andamento del numero di superamenti dei limite di velocità per tutti i veicoli pesanti e per direzione di marcia. Si puo' vedere che la percentuale maggiore di supermaenti dei limiti di velocita' (**`r perc_superamenti_Salerno`%**) è stata osservata nella direzione di Salerno per i veicoli principalmente di 18 tonnellate e 3.5 tonnellate. Una percentuale inferiore (**`r perc_superamenti_Avellino`%**) è stata osservata nella direzione di Avellino.
 
 
*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 6a.** Distribuzione delle velocita' istantanee per classe di autoveicoli su un tratto dell'autostrada A2 (31 Ago.-18 Sett.2017; Salerno)"}

# data$pois <- dpois(data$speed, lambda = mean(data$speed))
# data$nbinom <- dnbinom(data$speed, mu = mean(data$speed), size = 1)

data_salerno <- data %>%
  filter(direzione == "--> Salerno")

plots <- lapply(split(data_salerno, data_salerno$vehtype),FUN=function(speed_dist){ 
    # ggplot(aes((speed), fill = as.factor(vehtype))) +
    ggplot(speed_dist, aes(speed)) +
    # ggplot(aes( (mean_speed))) + 
    geom_density(alpha = 0.5) +
    ylim(0, 0.035) +
    # geom_histogram(binwidth=.05) +   ### counts
    stat_function(fun = dnorm, 
                  args = list(mean = mean(speed_dist$speed),
                           sd = sd(speed_dist$speed)), colour = "red") +  ## fit withGaussian
    theme_bw() +
     # geom_line(aes(y = pois), col = "blue") + 
    # geom_line(aes(y = nbinom), col = "green") + 
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
          axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5, size=12)) +
    ylab("densità") +
    xlab("velocità (km/h)") +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
    geom_vline(xintercept=mean(speed_dist$speed), color="red", linetype="dashed", size=0.5) 
})


# Finally, present the plots on 2 columns.
grid.arrange(plots$auto, plots$`veicoli pesanti`, nrow=1, ncol = 2,
             top = textGrob("        auto                                        veicoli pesanti",gp=gpar(fontsize=20,font=3)))

````


*<br/><br/>*




````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 6b.** Distribuzione delle velocita' istantanee per classe di autoveicoli su un tratto dell'autostrada A2 (31 Ago.-18 Sett. 2017; Avellino)"}

# data$pois <- dpois(data$speed, lambda = mean(data$speed))
# data$nbinom <- dnbinom(data$speed, mu = mean(data$speed), size = 1)

data_avellino <- data %>%
  filter(direzione == "<-- Avellino")

plots <- lapply(split(data_avellino, data_avellino$vehtype),FUN=function(speed_dist){ 
    # ggplot(aes((speed), fill = as.factor(vehtype))) +
    ggplot(speed_dist, aes(speed)) +
    # ggplot(aes( (mean_speed))) + 
    geom_density(alpha = 0.5) +
    ylim(0, 0.035) +
    # geom_histogram(binwidth=.05) +   ### counts
    stat_function(fun = dnorm, 
                  args = list(mean = mean(speed_dist$speed),
                           sd = sd(speed_dist$speed)), colour = "red") +  ## fit withGaussian
    theme_bw() +
     # geom_line(aes(y = pois), col = "blue") + 
    # geom_line(aes(y = nbinom), col = "green") + 
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
          axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5, size=12)) +
    ylab("densità") +
    xlab("velocità (km/h)") +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
    geom_vline(xintercept=mean(speed_dist$speed), color="red", linetype="dashed", size=0.5) 
})


# Finally, present the plots on 3 columns.
grid.arrange(plots$auto, plots$`veicoli pesanti`, nrow=1, ncol = 2,
             top = textGrob("            auto                                      veicoli pesanti",gp=gpar(fontsize=20,font=3)))

````


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Tabella 3.** "}



# estimate parameters
library(MASS)
library(fitdistrplus)

data_car_salerno <- data %>%
  filter(vehtype == "auto",
         direzione == "--> Salerno")
data_car_avellino <- data %>%
  filter(vehtype == "auto",
         direzione == "<-- Avellino")


data_fleet_salerno <- data %>%
  filter(vehtype == "veicoli pesanti",
         direzione == "--> Salerno")
data_fleet_avellino <- data %>%
  filter(vehtype == "veicoli pesanti",
         direzione == "<-- Avellino")


## fit with a "gaussian/normal" distribution
fit_cars_salerno <- fitdistrplus::fitdist(data_car_salerno$speed, "norm")
class(fit_cars_salerno) <- c("fitdist", "fitdistr") 
fit_cars_salerno <- as.data.frame(broom::tidy(fit_cars_salerno))
fit_cars_salerno$direzione <- "--> Salerno"
names(fit_cars_salerno) <- c("term", "auto", "car_error", "direzione")

fit_cars_avellino <- fitdistrplus::fitdist(data_car_avellino$speed, "norm")
class(fit_cars_avellino) <- c("fitdist", "fitdistr") 
fit_cars_avellino <- as.data.frame(broom::tidy(fit_cars_avellino))
fit_cars_avellino$direzione <- "<-- Avellino"
names(fit_cars_avellino) <- c("term", "auto", "car_error", "direzione")



fit_fleets_salerno  <- fitdistrplus::fitdist(data_fleet_salerno$speed, "norm")
class(fit_fleets_salerno) <- c("fitdist", "fitdistr") 
fit_fleets_salerno <- as.data.frame(broom::tidy(fit_fleets_salerno))
fit_fleets_salerno$direzione <- "--> Salerno"
names(fit_fleets_salerno) <- c("term", "veicoli pesanti", "fleet_error", "direzione")


fit_fleets_avellino  <- fitdistrplus::fitdist(data_fleet_avellino$speed, "norm")
class(fit_fleets_avellino) <- c("fitdist", "fitdistr") 
fit_fleets_avellino <- as.data.frame(broom::tidy(fit_fleets_avellino))
fit_fleets_avellino$direzione <- "<-- Avellino"
names(fit_fleets_avellino) <- c("term", "veicoli pesanti", "fleet_error", "direzione")



## plot
# denscomp(ft = fit_cars, legendtext = "Normal")
# denscomp(ft = fit_fleets, legendtext = "Normal")

cars_salerno <- gather(fit_cars_salerno,  "tipo veicolo", "velocità", 2:length(fit_cars_salerno), - c(direzione)) 
cars_avellino <- gather(fit_cars_avellino,  "tipo veicolo", "velocità", 2:length(fit_cars_avellino), - c(direzione)) 

fleets_salerno <- gather(fit_fleets_salerno, "tipo veicolo", "velocità", 2:length(fit_fleets_salerno), - c(direzione)) 
fleets_avellino <- gather(fit_fleets_avellino, "tipo veicolo", "velocità", 2:length(fit_fleets_avellino), - c(direzione)) 

car_fleets <- rbind(cars_salerno,
                    cars_avellino,
                    fleets_salerno,
                    fleets_avellino)
car_fleets <- car_fleets %>%
  filter(`tipo veicolo` %in% c("auto", "veicoli pesanti"))
car_fleets$`velocità` <- round(car_fleets$`velocità`, digits = 2)
names(car_fleets) <- c("", "direzione",  "tipo veicolo", "velocità")

Caption <- paste0("**Tabella 3.** Parametri ottenuti dalla modellizzazione della distribuzione delle **velocità instantanee** (dati VIASAT) con una distribuzione gaussiana. I parametri di valore medio e di deviazione standard sono riportati per automobli e veicoli pesanti.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(car_fleets, emphasize.strong.cols = 1, missing = "")

````

*<br/><br/>*




````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=7, fig.cap ="**Figura 111.** Media delle velocita' medie per classe di autoveicoli muniti del dispositivo Viasat sul sul tratto SENTINEL)."}


########################
### summary stats ######
########################

#######################
### Velocita' #########


STATS_velocita <- data %>%
  group_by(direzione,
           vehtype) %>%
  summarise(velocita_medie = mean(speed, na.rm = TRUE)) 

STATS_velocita <- as.data.frame(STATS_velocita)
STATS_velocita$velocita_medie <- round(STATS_velocita$velocita_medie, digits = 0)
categories <- as.character(unique(STATS_velocita$vehtype))

### plot velocita' #####
########################

q <- ggplot(data = STATS_velocita, 
            aes(vehtype, velocita_medie, fill = vehtype)) +
  theme_bw() +
  facet_wrap(~direzione) +
  geom_bar(stat = "identity")  +
  # facet_grid(corsia ~ direzione, scales = "free", space = "free") +
  theme(strip.text.x = element_text(size = 14, colour = "black")) +
  guides(fill=FALSE) +
  # scale_fill_manual(values=c("#7f7fff", "#7fbf7f", "#ff0000", "#e5e500", "#8e8e8e")) +
  theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=0, size=12)) +
  theme(axis.text.x=element_text(size=15,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                                     
  ylab("velocità (km/h)") +   
  ylim(0, 110) +
   theme(axis.title.y = element_text(face="bold", colour="black", size=15),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=15, colour="black")) +
  geom_text(aes(label = paste(velocita_medie, sep = "")), size = 6, hjust = 0.5, vjust = -0.5) +
  ggtitle("Velocità per classi di veicolo (31 Ago.-18 Set 2017)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 15))
q

```



*<br/><br/>*



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=7, fig.cap ="**Figura 111.** Media delle velocita' medie per classe di autoveicoli muniti del dispositivo Viasat sul sul tratto SENTINEL)."}


########################
### summary stats ######
########################

#######################
### Velocita' #########

#### Istogramma tutti i passaggi su velocità media con intervalli di 20km/h tutti i veicoli


## Salerno 
BBB <- NULL
bin_speed = seq(from = 0, to = 200, by =20)

for (i in 1:length(bin_speed)){
  #i=5
  if (i==1){
    AAA <- data %>%
      filter(direzione == "--> Salerno") %>%
      filter(speed <= bin_speed[i])  %>%
      summarise(counts = length(idterm))
  }else{
    AAA <- data %>%
     filter(direzione == "--> Salerno") %>%
      filter(speed <= bin_speed[i] & speed >= bin_speed[i-1]) %>%
      summarise(counts = length(idterm))
   
  }
  BBB<- rbind(BBB, AAA)
  
}

passaggi_20kmh_salerno <- as.data.frame(cbind(bin_speed, BBB))
passaggi_20kmh_salerno <- na.omit(passaggi_20kmh_salerno)
passaggi_20kmh_salerno$direzione <- "--> Salerno"



## Avellino 
BBB <- NULL
bin_speed = seq(from = 0, to = 200, by =20)

for (i in 1:length(bin_speed)){
  #i=5
  if (i==1){
    AAA <- data %>%
      filter(direzione == "<-- Avellino") %>%
      filter(speed <= bin_speed[i])  %>%
      summarise(counts = length(idterm))
  }else{
    AAA <- data %>%
     filter(direzione == "<-- Avellino") %>%
      filter(speed <= bin_speed[i] & speed >= bin_speed[i-1]) %>%
      summarise(counts = length(idterm))
   
  }
  BBB<- rbind(BBB, AAA)
  
}

passaggi_20kmh_avellino <- as.data.frame(cbind(bin_speed, BBB))
passaggi_20kmh_avellino <- na.omit(passaggi_20kmh_avellino)
passaggi_20kmh_avellino$direzione <- "<-- Avellino"

passaggi_20kmh <- rbind(passaggi_20kmh_salerno,
                        passaggi_20kmh_avellino)

## plot

passaggi_20kmh$bin_speed <- as.factor(passaggi_20kmh$bin_speed)



p <- ggplot(data = passaggi_20kmh,
              aes(bin_speed, counts, fill = bin_speed)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    facet_wrap(~direzione) +
    guides(fill=FALSE) +
    # ylim(0, 90) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=13,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    xlab(expression(paste("velocità (km / h)"))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=13, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13)) +
    # scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("Numero passaggi a velocità media ad intevalli di 20km/h") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p



```

*<br/><br/>*

## 4. Distribuzione delle velocità

La distribuzione delle velocità istantanee per automobili e veicoli pesanti è rappresentata in **Figura 6a e Figura 6b**. Per entrambe le tipologie di veicoli (automobili e veicoli pesanti) si è cercato di modelizzare le distribuzioni con una curva Gaussiana. Come riportato nella **Tabella 3**, il valore medio per la distribuzione delle velocità delle automobili è stato stimato a **`r car_fleets$velocità[1]` km/h** con una deviazione standard di **`r car_fleets$velocità[2]` km/h**. Invece, per i veicoli pesanti, il valore medio per la distribuzione delle velocità è stato stimato a **`r car_fleets$velocità[3]` km/h** con una deviazione standard di **`r car_fleets$velocità[4]` km/h**. 


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 7.** Distribuzione delle velocità di tutti i veicoli ottenuta dal confronto di dati ANAS e FCD (Viasat) per il periodo 31 Ago.-18 Sett. 2017"}



# estimate paramters
library(MASS)
library(fitdistrplus)
## fit with a "gaussian/normal" distribution
fit_VIASAT <- fitdistrplus::fitdist(data$speed, "norm")
class(fit_VIASAT) <- c("fitdist", "fitdistr") 
fit_VIASAT <- as.data.frame(broom::tidy(fit_VIASAT))
names(fit_VIASAT) <- c("term", "veicoli VIASAT", "car_error" )


fit_VIASAT <- gather(fit_VIASAT,  "tipo veicolo", "velocità", 2:length(fit_VIASAT)) 
fit_VIASAT <- fit_VIASAT %>%
  filter(`tipo veicolo` %in% c("veicoli VIASAT"))
fit_VIASAT$`velocità` <- round(fit_VIASAT$`velocità`, digits = 2)



### load ANAS data ####
velocita_ANAS <-  read.csv(paste0("D:/ENEA_CAS_WORK/SENTINEL/ANAS/velocita_ANAS.csv"),
         header = T, sep=",")[-1]


names(velocita_ANAS)[names(velocita_ANAS) == 'velocità'] <- 'speed'

AAA <- data.frame(observation = "ANAS", velocità = velocita_ANAS$speed)
BBB <- data.frame(observation = "VIASAT", velocità = data$speed)
ZZZ <- rbind(AAA, BBB)
colorData <- brewer.pal(length(unique(ZZZ$observation)), "Set1")
# Replace first color first wanted grey
colorData[1] <- "red"
colors <- c(
  "ANAS" = "red",
  "VIASAT" = "blue"
)



p <- ggplot(data =velocita_ANAS,  aes((x=speed))) +
    geom_density(alpha = 0.5, size=2, colour = "red") +
    geom_density(data = data, size=2, colour = "blue") +
    geom_density(aes(velocità, colour=factor(observation)), size=2, data=ZZZ) +
    scale_color_manual(values = colorData, name = "") +
    stat_function(fun = dnorm, args = list(mean = mean(velocita_ANAS$speed),
                                           sd = sd(velocita_ANAS$speed)), colour = "red") + 
    stat_function(fun = dnorm, args = list(mean = mean(data$speed),
                                           sd = sd(data$speed)), colour = "blue") +
    # scale_x_continuous(trans='log10') +
    guides(fill=guide_legend(title="tipo veicolo")) +
    theme_bw() +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
          axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
    ylab("densità (u.a)") +
    # ylab("conteggi") +
    xlab("velocità (km/h)") +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
   geom_vline(xintercept=mean(  velocita_ANAS$speed), color="red", linetype="dashed",
              size=0.5) +
   geom_vline(xintercept=mean(  data$speed), color="blue", linetype="dashed",
              size=0.5) +
    ggtitle("Distribuzione delle velocità istantanee (ANAS & VIASAT; 31 Ago.-02 Ott. 2019)") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
# p

```



*<br/><br/>*

## Stati del traffico (Livelli di Servizio LOS)

Il volume di traffico o flusso veicolare (o anche portata veicolare): è il numero dei veicoli che passa in una determinata sezione stradale durante un intervallo di tempo. In genere, si esprime in termini: annuali [veic/anno], giornalieri [veic/giorno], orari [V60 o V = veic/h].

La portata veicolare di progetto *FLUSSO di SERVIZIO* [v = veic/h]: è il massimo valore del flusso orario sotto determinate condizioni della strada e di traffico; è determinato in un intervallo di tempo inferiore all’ora e, generalmente, si utilizza un intervallo di tempo di **15 minuti**. Quindi il FLUSSO di SERVIZIO è definito come $V_{h} = 4*max(V_{15 min})$, dove $max(V_{15 min})$ rappresenta i veicoli transitati nei 15 minuti più caricati nell’ora. Invece, il *flusso reale orario* è definito come  $V_{h} = 4V_{15 min}$, dove $4V_{15 min}$ rappresenta il volume di traffico in un intervallo di 15 minuti.  

Essendo i veicoli VIASAT solo una frazione dei veicoli misurati da ANAS, abbiamo stimato il conteggio dei veicoli VIASAT applicando il **fattore di rappresentatività** riportato in Tabella 2. La densità spaziale, intesa come il numero d veicoli nella sezione stradale per corsia, è stata stimata per ogni ora del giorno. Il rapporto tra il *flusso reale orario* per corsia e la *velocità media* è risultato nella stima della **densità spaziale** che è rappresentata in **Figura 8**.  


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 7.** Flusso per ora della giornata su un tratto dell'autostrada A2 (31 Ago.-02 Ott. 2019; Salerno-Avellino)."}

###########################################################
#### TRAFFIC STATES #############################
#########################################



#############################
#### FLUX ###################
#############################

COEFF_PENETR <- 3.8

## get all passaggi (conteggi) by hour
## resample data  y 15 minutes
VIASAT_STATS_passaggi_hourly <- data %>%
  # filter(u %in% c(25844069, 32048592) & v %in% c(25844113, 246509515)) %>%
  group_by(Date=floor_date(timedate, "15 minute"), direzione, day, hour, u, v) %>%
  summarize(instant_speed=mean(speed),
              count = length(idterm))


VIASAT_STATS_passaggi_hourly <- as.data.frame(VIASAT_STATS_passaggi_hourly)

### THEORY (pag. 26)
### https://moodle2.units.it/pluginfile.php/101161/mod_resource/content/1/PIV_2016-2017_L03_TrafficoCapacita.pdf

#### calcola capacita' massima e PHF (Peak Hour Factor)
VIASAT_STATS_passaggi_15min <- VIASAT_STATS_passaggi_hourly %>%
  group_by(direzione, u,v) %>%
  mutate(time_15 = format(ymd_hms(Date), "%H:%M:%S"))

VIASAT_STATS_passaggi_15min <- VIASAT_STATS_passaggi_15min %>%
  group_by(direzione, u,v, time_15) %>%
  summarise(flux = mean((count)/1.0, na.rm = TRUE))
## from the result you can see the peak hour (ora di punta)


# CAPACITÀ/PORTATA: massimo volume orario di traffico in una generica sezione e in determinate condizioni operative,relativo ad un intervallo di tempo che generalmente è fissato in 15 min.
PORTATA <- ((4*max(VIASAT_STATS_passaggi_15min$flux))*100)/COEFF_PENETR


VIASAT_STATS_passaggi_hourly <- VIASAT_STATS_passaggi_hourly %>%
  group_by(direzione, u,v,
           hour) %>%
  summarise(flux = mean((count)/0.25, na.rm = TRUE))


#####------ peak hour factor - PHF ---------- #######
### volume orario
V = (max(VIASAT_STATS_passaggi_hourly$flux)*100)/COEFF_PENETR
PHF <- round(V/PORTATA, digits = 2)

#### rescale to ANAS data
VIASAT_STATS_passaggi_hourly$flux <- ((VIASAT_STATS_passaggi_hourly$flux)*100)/COEFF_PENETR   



###################################
## percent time-spent-following ###

VIASAT_STATS_passaggi_hourly$perc_time_spent_foll <- round(100*(1-exp(-0.000879*VIASAT_STATS_passaggi_hourly$flux)),
                              digits = 0)


VIASAT_STATS_passaggi_hourly$hour <- unfactor(VIASAT_STATS_passaggi_hourly$hour)
VIASAT_STATS_passaggi_hourly$hour <- as.numeric(VIASAT_STATS_passaggi_hourly$hour)

p <- ggplot(data = VIASAT_STATS_passaggi_hourly,
              aes(hour, flux, fill = hour)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    facet_wrap( ~ direzione, ncol = 4) +
    # facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    # ylim(0, 1100000) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("flusso (veicoli/ora)") +            # Set y-axis label
    xlab(expression(paste(""))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("FLusso orario conforme ad ANAS (31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  # p

  
````
 
 
 
*<br/><br/>*

 
````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 8.** Densità spaziale (veicoli/km) stimata per ogni ora della giornata su un tratto dell'autostrada A2 (31 Ago.-18 Sett. 2017; Salerno-Avellino). Per il calcolo della densita' spaziale, i conteggi sono stati aggiustati secondo il coefficiente di penetrazione rispetto ai dati ANAS."}
 
########## density ##################################
### il calcolo della densita' e' PER CORSIA !!! ####

## length is in meters...

lunghezza <- data %>%
  group_by(u,v, length) %>%
  summarize(AAA = mean(speed))
lunghezza <- lunghezza %>%
  dplyr::select(u,v,length)


passaggi_density <- data %>%
   # filter(u %in% c(25844069, 32048592) & v %in% c(25844113, 246509515)) %>%
   group_by(Date=floor_date(timedate, "15 minute"), 
             u,v, hour, direzione,
             day, length) %>%
    summarize(count = length(idterm),
               mean_speed = round(mean(speed), digits = 0))



density_by_day <- passaggi_density %>%
  group_by(u,v, direzione, hour) %>%
  summarize(count = mean((count)/0.25, na.rm = TRUE),
            mean_speed = mean(mean_speed))


density_by_day <- density_by_day %>%
  left_join(lunghezza, by = c("u", "v")) 

density_by_day$hour <- unfactor(density_by_day$hour)
density_by_day$hour <- as.numeric(density_by_day$hour)

density_by_day <- density_by_day %>%
  left_join(VIASAT_STATS_passaggi_hourly, by = c("direzione", "u", "v", "hour"))


#### rescale to ANAS data
density_by_day$count <- ((density_by_day$count)*100)/COEFF_PENETR  # 3.8


density_by_day <- density_by_day %>%
  group_by(direzione, hour) %>%
  summarize(length= sum(length),
            count = sum(count),
            flux = mean(flux),
            perc_time_spent_foll = mean(perc_time_spent_foll),
            mean_speed = mean(mean_speed))


### flusso reale (per corsia e con fattori di correzzione)
### https://moodle2.units.it/pluginfile.php/101161/mod_resource/content/1/PIV_2016-2017_L03_TrafficoCapacita.pdf
## frazione veicoli pesanti
PT <- max(total_counts_direzione_type[total_counts_direzione_type$classi == "veicoli pesanti", ]$`frazione %`)/100
## fhv: coefficiente per tipo di veicoli
fhv <- 1/(1+PT*(2.5-1))   ## il numero 2.5 si trova nella tabell "exibits 28-3 pag 67 del documento di sopra.


#### FLUSSO VEICOLARE
### the real_flux is calculated on only one corsia
density_by_day$real_flux <- (density_by_day$flux)/(PHF*2*0.8163*1)


### DENSITA' veicolare: DENSITÀ DI TRAFFICO [D = veic/km]: rapporto tra il VOLUME di traffico ## [V] misurato in un determinato tronco stradale in un breve intervallo di tempo (15 min.) e
### la media delle VELOCITÀ [S] dei veicoli:

density_by_day$density <- (density_by_day$real_flux)/(density_by_day$mean_speed)

## add field for max speed
density_by_day$max_speed <- as.numeric(130)


###################################
## percent time-spent-following ###

# https://www.frontiersin.org/articles/10.3389/fbuil.2020.00001/full

# density_by_day$perc_time_spent_foll <-   43.930 + 9.601*(density_by_day$density) − 0.8432*(density_by_day$density)^2 + 0.02764*(density_by_day$density)^3

density_by_day$perc_time_spent_foll <- round(100*(1-exp(-0.000879*density_by_day$flux)),
                              digits = 0)


p <- ggplot(data = density_by_day,
              aes(hour, density, fill = density)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    facet_wrap( ~ direzione, ncol = 4) +
    # facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    # ylim(0, 1100000) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("Densità (veicoli / km)") +            # Set y-axis label
    xlab(expression(paste(""))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("Densità spaziale nella sezione stradale (31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p
  

````



*<br/><br/>*

 
````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 8a.** Densità spaziale (veicoli/km) stimata per ogni ora della giornata su un tratto dell'autostrada A2 (31 Ago.-18 Sett. 2017; Salerno-Avellino). Per il calcolo della densita' spaziale, i conteggi sono stati aggiustati secondo il coefficiente di penetrazione rispetto ai dati ANAS."}

###############################################################
### FLUSSOGRAMMA ##############################################
###############################################################

## diagramma bidimensionale flusso - velocità
## https://www.researchgate.net/publication/313478032_ASPETTI_GENERALI_DEL_DIAGRAMMA_FONDAMENTALE_DEL_TRAFFICO


  passaggi <- data %>%
   group_by( hour, direzione) %>%
    summarize(count = length(idterm),
               mean_speed = round(mean(speed), digits = 0))
  
  
  passaggi <- as.data.frame(passaggi)
  
  p <- ggplot(passaggi, aes(x= count, y = mean_speed)) + 
       geom_point( color = "darkred", linetype="twodash",
              lwd=1.5) +
   geom_smooth() +
    theme_bw() +
    xlim(0, max(passaggi$count)) +
    ylim(0, 100) +
  facet_wrap( ~ direzione, ncol = 4) +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=12)) +
    theme(axis.text.x=element_text(size=12, colour = "black")) +
    theme(axis.title.x = element_text(face="bold", colour="black", size=11)) +
    xlab("flusso (veicoli/ora)") +
    ylab("velocita' (km/h)") +
     theme(axis.title.x = element_text(face="bold", colour="black", size=13),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=13, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    ggtitle("andamento velocità - flusso sull'arco SENTINEL") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 11))
p


````

*<br/><br/>*

Come riportato sopra, il massimo valore di flusso orario, anche indicato come *portata veicolare di progetto* (veicoli/ora) è stato determinato in un intervallo di tempo di 15 minuti ed e' risultato essere **`r PORTATA` veicoli/ora**. È stato quindi calcolato anche il **fattore dell'ora di punta** o **PHF** (Peak Hour Factor) inteso come il rapporto tra il flusso orario e la portata riferiti all’ora di punta. Considerando i conteggi VIASAT sull'arco SENTINEL, abbiamo stimato un valore PHF di **`r PHF`**. Tale valore rientra nei valori tipici del PHF per autostrade e strade extraurbane.

Per il calcolo della densità spaziale per corsia, abbiamo calcolato il flusso orario per corsia in *condizioni reali* ($U_{R}$) che tiene conte di alcuni fattori di correzione come il *PHF*, il numero di corsie, la percentuale di veicoli pesanti ($f_{HV}$) ed il tipo di utenti ($f_{p}$). **Tabella S1** riporta le principali equazioni di riferimento usate per il calcolo del flusso orario reale e della densità veicolare.



*<br/><br/>*


```{r Tabella  S1, echo = FALSE, warning = FALSE, cache = FALSE, out.width = "70%", results = 'asis', message = FALSE, comment=FALSE}

# build table reporting and explaining formulas about metrics
Comparison_metrics <- c("flusso reale", "correzione per veicoli pesanti", "densita'")


Mathematical_formulas <- c("$$U_{R} [veic/ora/corsia] = \\frac{V_{h}}  {PHF * N * f_{HV} * f_{p} }$$, dove $V_{h}$ e' il flusso orario (veic/ora), $N$ il numero di corsie, $PHF$ il Peak Hour Factor, $f_{HV}$ la correzione per i veicoli pesanti, $f_{P}$ la correzione per il tipo di utenti.",
                           
                           "$$f_{HV} = \\frac{1} {1 + P_{T}(E_{T}-1)} $$, dove $P_{T}$ e' la percentuale di veicoli pesanti, $E_{T}$ il numero di autovetture equivalenti rispettivamente a un veicolo pesante.",
                           "$$D [veic/km] = \\frac{U_{R}} {velocita' media}$$ ")


Characteristics <- c("il flusso reale e' per singola corsia ed e' stato calcolato su una base di 15 minuti ($V_{h} = 4V_{15 min}$), $f_{P}$ e' un coefficiente che tiene conto del tipo di utenti e varia 0,85 a 1,00 (i valori più
bassi si utilizzano in presenza di utenti non abituali)", 

"il valore di $E_{T}$ e' dipende dal tipo di strada e varia da 1.2 a 4.5. Per le autostrade assumiamo un valore di 2.5", 

"la media delle velocita' e' stata calcolata su intervalli temporali di 15 minuti")

df_Comparison_metrics <- data.frame(Comparison_metrics, Mathematical_formulas, Characteristics)
names(df_Comparison_metrics) <- c("grandezza", "formula", "caratteristiche")

Caption <- paste0("**Tabella S2.** Equazioni principali usate per il calcolo dei flussi reali (ref. Highway Capacity Manual (HCM). Washington, D.C: Transportation Research Board, National Research Council. National Research Council (U.S. Ed.2000)).")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) 
panderOptions("table.split.table", Inf) 
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left'))
pander(df_Comparison_metrics, emphasize.strong.cols = 1, missing = "")
                        

```

*<br/><br/>*


Gli stati del traffico sono stati stimati usando le procedure riportate nell'*Highway capacity manual. Washington, D.C: Transportation Research Board, National Research Council. National Research Council (U.S.) (Ed.). (2000)*. Per la sezione autostradale in esame, i livelli di servizio (Level of Service - LOS) o stati del traffico per ogni ora della giornata sono stati stimati usando la densita' veicolare. I livelli di servizio sono definiti come la misura della prestazione della strada nello smaltire il traffico. Per convenzione, i livelli di servizio  sono 6: da LOS “A” a LOS “F”. I LOS da “A” a “D” hanno una densità inferiore a quello corrispondente alla capacità della strada. Il LOS E corrisponde alla densità critica
e quindi alla capacità della strada. Il LOS “F” ha densità maggiori e quindi siamo in presenza di flusso instabile.
Come mostrato in **Figura 9**, durante le ore della giornata sulla sezione stradale in esame abbiamo stimato quattro tipi di LOS: 1) LOS **A** (**flusso libero**): circolazione libera con massimo comfort e flusso stabile. Questo è stato osservato prevalentemente durante le ore notturne e in prima mattinata, 2) LOS **C** (**flusso stabile**): circolazione libera con modesta riduzione della velocità e comfort accettabile. Questo tipo di flusso è stato osservato durante la maggior parte delle ore centrali della giornata soprattutto nella direzione verso Salerno, 3) il LOS **D** (**flusso inzialmente instabile**) indica che ci sono vincoli alla circolazione, basso comfort ed il flusso può iniziare ad essere instabile con conseguente riduzione del comfort di guida. Questo tipo di flusso e' stato osservato nelle ore serali nella direzioni di Salerno ed Avellino ma anche nella maggior parte delle ore diurne nella direzione di Salerno. L'LOS **D** e' stato solo osservato nella direzione di Avellino verso le ore **10:00**. 


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 9.** FLusso orario (veicoli/ora) e stati del traffico calcolati sul tratto dell'autostrada A2 (31 Ago.-18 Sett. 2017; Salerno-Avellino). Le lettere **A** e **B** indicano uno stato **LIBERO**, la lettera **C** indica un stato **STABILE**, le lettere **D** ed **E** indicano uno stato **INIZIALMENTE INSTABILE** ed **INSTABILE**, rispettivamente. Per il calcolo del flusso orario, i conteggi sono stati aggiustati secondo il coefficiente di penetrazione rispetto ai dati ANAS."}



### function to estimate the traffic states (LOS - Level of Service)
traffic_states_fun <- function(time_at_mean_speed, max_speed,
                               mean_speed, density){
  ## urban traffic
   if ((time_at_mean_speed > 85) & (max_speed == 50) & (mean_speed > 42.2) & (density <7))
    LOS = "A"
   else if ((time_at_mean_speed > 85) & (max_speed == 90) & (mean_speed > 76.5) & (density <7))
    LOS = "A"
   if ((time_at_mean_speed > 67) & (time_at_mean_speed < 85) & (max_speed == 50) & (mean_speed > 33.5) &  (mean_speed < 42.5) & (density < 11) & (density>7)) 
    LOS = "B"
  else if ((time_at_mean_speed > 67) & (time_at_mean_speed < 85) & (max_speed == 90) & (mean_speed >    60.3) &  (mean_speed < 76.5) & (density < 11) & (density>7)) 
    LOS = "B"
  ###....and so on......
  ## strade a due corsie traffic
  else if ((time_at_mean_speed <= 35) & (max_speed == 130) & (mean_speed > 90))
    LOS = "A"
  else if ((time_at_mean_speed > 35) & (time_at_mean_speed <= 50) & (max_speed == 130) & (mean_speed > 80) &  (mean_speed < 90)) 
    LOS = "B"
   else if ((time_at_mean_speed > 50) & (time_at_mean_speed <= 65) & (max_speed == 130) & (mean_speed > 70) &  (mean_speed < 80)) 
    LOS = "C"
    else if ((time_at_mean_speed > 65) & (time_at_mean_speed <= 80) & (max_speed == 130) & (mean_speed > 60) &  (mean_speed < 70)) 
    LOS = "D"
  else if ((time_at_mean_speed > 80) & (max_speed == 130) & (mean_speed <= 60)) 
    LOS = "E"
  ### use fluxes
 else if(flux < 1440)
   LOS = "A"
 else if(flux < 2260 & flux > 1440)
   LOS = "B"
 else if(flux < 3150 & flux > 2260)
   LOS = "C"
 else if(flux < 3770 & flux > 3150)
   LOS = "D"
 else if (flux < 4120 & flux > 3770)
   LOS = "E"
  
  else LOS = NA
  
  return(LOS)
}

#####################################################################################
####################################################################################

## https://moodle2.units.it/pluginfile.php/101161/mod_resource/content/1/PIV_2016-2017_L03_TrafficoCapacita.pdf

### function to estimate the traffic states (LOS - Level of Service)
traffic_states_fun <- function(density){
  ## autostrade
   if ((density <= 7))
    LOS = "A"
   else if ((density <= 11) & (density > 7))
    LOS = "B"

   else if ((density <= 16) & (density > 11))
    LOS = "C"

   else if ((density <= 22) & (density > 16))  
       LOS = "D"
    else if ((density <= 28) & (density > 22))  
       LOS = "E"
     else if ((density >28))  
       LOS = "F"

  else LOS = NA

  return(LOS)
}



# ### function to estimate the traffic states (LOS - Level of Service)
# traffic_states_fun <- function(density){
#   ## autostrade
#    if ((density <= 7) & (speed < 120) & (flux <= 840))
#     LOS = "A"
#    
#    else if ((density < 11) & (density > 7) & (speed < 120) & (flux <= 1320) & (flux > 840))
#     LOS = "B"
# 
#    else if ((density <= 16) & (density > 11) & (speed <= 115) & (speed >120) & (flux >1320) & (flux <= 1840)  )
#     LOS = "C"
# 
#    else if ((density < 22) & (density > 16) & (speed <= 99.6) & (speed >115) & (flux >1840) & (flux <= 2200) )
#        LOS = "D"
#    
#     else if ((density <= 28) & (density > 22) & (speed <= 85.7) & (speed >99.6) & (flux >2200) & (flux <= 2400) )
#        LOS = "E"
#     
#      else if ((density >28))
#        LOS = "F"
# 
#   else LOS = NA
# 
#   return(LOS)
# }


time_at_mean_speed = as.vector(density_by_day$perc_time_spent_foll)
max_speed = density_by_day$max_speed
mean_speed = density_by_day$mean_speed
density = density_by_day$density
flux = density_by_day$flux

## get all Level of Services by hour and by direction
los = NULL
for (i in 1:nrow(density_by_day)) {
  # print(paste(c("==========", i)))
  LOS = traffic_states_fun(density[i])
  # print(LOS)
  los = rbind(los, LOS)
}

LOS <- as.data.frame(los)
rownames(LOS) <- NULL
names(LOS) <- "LOS"
density_by_day <- cbind(density_by_day, LOS)

# density_by_day <- as.data.frame(density_by_day)
density_by_day$hour <- as.numeric(density_by_day$hour)
density_by_day$LOS <- as.factor((density_by_day$LOS))

p <- ggplot(data = density_by_day,
              aes(hour, flux, fill = LOS)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    facet_wrap( ~ direzione, ncol = 4) +
    # facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    ylim(0, max(density_by_day$flux)+20) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("flusso (veicoli / ora)") +            # Set y-axis label
    xlab(expression(paste(""))) +
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
      geom_text(aes(label = paste(LOS, sep = "")), size = 4, hjust = 0.5,  vjust = -0.5) +
    ggtitle("FLusso orario conforme ad ANAS e Livelli di Servizio (31 Ago.-18 Sett. 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p

````

*<br/><br/>*

## Rappresentazione grafica


Il numero di veicoli che attraversano l'arco SENTINEL nella direzione verso Salerno ed Avellino in una giornata tipo (2 Settembre 2019) e' stato calcolato come segue:

1) La tabella di dati **mapmatching** del database **HAIG_Viasat_SA** è stato interrogata applicando un filtro per gli estremi (u,v) dell'arco SENTINEL. Sono stati quindi individuati gli identificativi di tutti i veicoli (automobili e mezzi pesanti) che hanno attraversato l'**arco SENTINEL** durante la giornata del 2 Settembre 2019. Gli identificativi di veicoli sono stati organizzati nella forma di una lista.

2) La tabella di dati  **mapmatching** e' stata nuovamente interrogata assieme alla tabella **dataraw** dei dati originali VIASAT per estrarre **tutti gli archi** attraversati per tipoligia di veicoli (automobili e/o mezzi pesanti) durante la giornata del 2 Settembre 2019.


3) Gli archi individuati al punto 2) sono stati filtrati con gli identificativi dei **veicoli che attraversano l'arco SENTINEL**.

4) Sono stati individuati tutti i **viaggi** che hanno interessato l'arco SENTINEL sia verso la direzione di Salerno che quella di Avellino. Quindi e' stata indviduata la **posizione dell'arco SENTINEL** nella **sequenza di archi** che formano ogni singolo viaggio. In seguito, separatamente per la direzione di Salerno (colore rosso nella Figura 10) e per quella di Avellino (colore blue nella Figura 10), sono stati filtrati tutti gli archi relativi ai singoli viaggi transitati sull'arco SENTINEL.

*<br/><br/>*

```{r, echo=FALSE, fig.cap="**Figura 10**.Rappresentazione dei conteggi di mezzi pesanti transitati sull'arco SENTINE il giorno 02 Settembre 2019 (per entrambe le direzioni verso Salerno (rosso) e verso Avellini (blu)).", out.width = '100%'}
knitr::include_graphics("D:/ENEA_CAS_WORK/SENTINEL/viasat_data/conteggi_pesanti_SENTINEL.png")
```


*<br/><br/>*


```{r, echo=FALSE, fig.cap="**Figura 11**.Rappresentazione dei conteggi di tutti gli autoveicoli (mezzi pesanti ed auto).", out.width = '100%'}
knitr::include_graphics("D:/ENEA_CAS_WORK/SENTINEL/viasat_data/ALL_conteggi_SALERNO_rete.png")
```


*<br/><br/>*



