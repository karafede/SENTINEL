---
title: "Analisi dati ANAS A2 Km5+004"
author:
- Federico Karagulian
date: "ultima versione `r format(Sys.time(), '%d %B %Y, %H:%M')`"
output:
  html_document: default
  pdf_document: default
  word_document: 
    reference_docx: word_style_FK.docx
  number_sections: true
  bookdown::word_document: default
---


## 1. Serie temporale di conteggi di veicoli

Di seguito riportiamo alcune serie temporali per il conteggio dei veicoli sulle corsie dell'autostrada **A2**, sul tratto **671 (A2, Km 5+004)** in entrambe le direzioni: verso *Salerno* (ascendente) e verso *Avellino* (discendente). I conteggi si riferiscono al periodo **2017-2018**.
**Figura 1** riporta la serie temporale di dati orari per il numero di passaggi di tutti gli autoveicoli nella direzione verso Salerno. Mentre la **Figura 2** riporta la serie temporale della somma di tutti i passaggi giornalieri per tutti i veicoli. Entrambe le figure mostrano chiaramente che la *Corsia 1* e' quella con il piu' alto numero di passaggi di veicoli. 
Giusto per precisare, il tratto dell'autostrada A2 che stiamo considerando ha *due* corsie per carreggita. Salvo errate interpretazioni, la *Corsia 1* nella direzione *Salerno* e' la corsia di destra, mentre la corsia di sorpasso e' la *Corsia 2* che si trova a sinistra. Stesso discorso vale per la direzione verso Avellino, dove la *Corsia 3* e' quella di destra, mentre la *Corsia 4* e' quella di sorpasso e si trova sulla sinistra.

**N.B**. Durante le ore diurne si vede chiaramente che, anche la *Corsia 3* e la *Corsia 4* sono percorse da alcuni veicoli. La domanda che viene da chiedersi e' se per ogni senso di marcia,  la *Corsia 3* e la *Corsia 4* (direzione Salerno) e la *Corsia 1*, *Corsia 2* (direzione Avellino), sono parte della carreggiata opposta oppure sono delle corsie di uscita o di entra o di emergenza nella medesima carreggita (direzione)?  

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Figura 1.** Serie temporale oraria del numero di passaggi per tutti i tipi di autoveicoli sull'autostrada A2 (km5+004) direzione Salerno"}


rm(list = ls())

library(ggplot2)
library(stringr)
library(tidyr)
library(readr)
library(broom)
library(threadr)
library(dplyr)
library(dygraphs)
library(ggpmisc)
library(plotly)
library(GGally)
library(htmlwidgets)
library(htmltools)
library(webshot)
library(ggrepel)
library(openair)
library(widgetframe)
options(scipen=5)

# saving the original graphical parameters
op <- par(no.readonly = TRUE)

# load data
# setwd
WD <- "C:/ENEA_CAS_WORK/SENTINEL/ANAS/"

# read all data
DB_2017 <- read.csv(paste0(WD,"671_(A2_Km_5+004)_2017.csv"),
                      header = T, skip = 48, sep=";")
DB_2018 <- read.csv(paste0(WD,"671_(A2_Km_5+004)_2018.csv"),
                      header = T, skip = 48, sep=";")
# get last 8 lines of DB_2017 and set them to 0  (4*2, ASCEDNDENTI & DISCENDENTI)
DB_2017 <- as.data.frame(DB_2017)
DB_2018 <- as.data.frame(DB_2018)

DB_2017[(nrow(DB_2017)-8): nrow(DB_2017), ][names(DB_2017) == 'Passaggi.Totali'] <- 0

# get first 8 lines of DB_2018 and set them to 0  (4*2, ASCEDNDENTI & DISCENDENTI)
DB_2018[1:8, ][names(DB_2018) == 'Passaggi.Totali'] <- 0

# Bind and perform data cleaning
DB <- rbind(DB_2017, DB_2018)


headers <- names(DB)
headers <- str_replace_all(headers, "\\.|\\(|\\)", "_")
headers <- make.names(headers, unique = TRUE)
headers <- str_replace_all(headers, "\\.", "_")
headers <- str_to_lower(headers)

# Give table headers
names(DB) <- headers

write.csv(DB, "DB.csv")
DB <- read.csv("DB.csv", header = TRUE)

# format DateTime
DB$riferimento_temporale <- lubridate::dmy_hms(DB$riferimento_temporale, tz = "UTC")
DB$fine_periodo_di_aggregazione <- lubridate::dmy_hms(DB$fine_periodo_di_aggregazione, tz = "UTC")

# DB1 <- DB %>%
#   filter(direzione == "A" & corsia %in% c("1","2"))
# DB2 <- DB %>%
#   filter(direzione == "D" & corsia %in% c("3","4"))
# DB <- rbind(DB1, DB2)

#########################################
## Quick dynamic time series ############
#########################################

## A2 Direzione Salerno (Ascendente)

names(DB)[names(DB) == 'fine_periodo_di_aggregazione'] <- 'date'

Corsia_1A <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 1 & direzione == "A")
names(Corsia_1A)[names(Corsia_1A) == 'passaggi_totali'] <- 'passaggi_totali_corsia_1_ASC'

Corsia_2A <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 2 & direzione == "A")
names(Corsia_2A)[names(Corsia_2A) == 'passaggi_totali'] <- 'passaggi_totali_corsia_2_ASC'

Corsia_3A <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 3 & direzione == "A")
names(Corsia_3A)[names(Corsia_3A) == 'passaggi_totali'] <- 'passaggi_totali_corsia_3_ASC'

Corsia_4A <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 4 & direzione == "A")
names(Corsia_4A)[names(Corsia_4A) == 'passaggi_totali'] <- 'passaggi_totali_corsia_4_ASC'

# join all data together
All_Corsie_ASCENDENTI <- Corsia_1A %>%
  left_join(Corsia_2A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_3A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_4A, by = "date")


# Build timeseries for plots
ts_TOT_passaggi <- data_frame_to_timeseries(All_Corsie_ASCENDENTI %>%
                                               select(date,
                                                      passaggi_totali_corsia_1_ASC,
                                                      passaggi_totali_corsia_2_ASC,
                                                      passaggi_totali_corsia_3_ASC,
                                                      passaggi_totali_corsia_4_ASC))

ts <- cbind(ts_TOT_passaggi$passaggi_totali_corsia_1_ASC, 
            ts_TOT_passaggi$passaggi_totali_corsia_2_ASC,
            ts_TOT_passaggi$passaggi_totali_corsia_3_ASC,
            ts_TOT_passaggi$passaggi_totali_corsia_4_ASC)

names(ts) <- c("counts_corsia_1_ASC",
                "counts_corsia_2_ASC",
                "counts_corsia_3_ASC",
                "counts_corsia_4_ASC")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (conteggi totali)")  %>% 
    dygraphs::dySeries("counts_corsia_1_ASC",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("counts_corsia_2_ASC",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("counts_corsia_3_ASC",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("counts_corsia_4_ASC",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "Conteggi Totali") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

# frameWidget(plot, height = 500, width = '95%')

```

*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 2.** Serie temporale della somma giornaliera di tutti i passaggi sull'autostrada A2 (km5+004) direzione Salerno. La somma e' riferita a tutti i tipi di autoveicoli."}

# make daily SUMS
Daily_All_Corsie_ASCENDENTI <- data.frame(timeAverage(mydata   = All_Corsie_ASCENDENTI,
                                    avg.time   = "day", statistic  = "sum"))
            #start.date = round(min(DF$General$date, na.rm = TRUE), units = "hours"), 
            # end.date   = round(max(DF$General$date, na.rm = TRUE), units = "hours")))
                

# Build timeseries for plots
ts_TOT_passaggi <- data_frame_to_timeseries(Daily_All_Corsie_ASCENDENTI %>%
                                               select(date,
                                                      passaggi_totali_corsia_1_ASC,
                                                      passaggi_totali_corsia_2_ASC,
                                                      passaggi_totali_corsia_3_ASC,
                                                      passaggi_totali_corsia_4_ASC))

ts <- cbind(ts_TOT_passaggi$passaggi_totali_corsia_1_ASC, 
            ts_TOT_passaggi$passaggi_totali_corsia_2_ASC,
            ts_TOT_passaggi$passaggi_totali_corsia_3_ASC,
            ts_TOT_passaggi$passaggi_totali_corsia_4_ASC)

names(ts) <- c("counts_corsia_1_ASC",
                "counts_corsia_2_ASC",
                "counts_corsia_3_ASC",
                "counts_corsia_4_ASC")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (Somma passaggi giornalieri)")  %>% 
    dygraphs::dySeries("counts_corsia_1_ASC",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("counts_corsia_2_ASC",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("counts_corsia_3_ASC",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("counts_corsia_4_ASC",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "Somma conteggi totali") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

```


*<br/><br/>*

Per quando riguarda il contenggio dei passaggi di tutti i tipi di autoveicoli sul tratto in esame dell'A2 in direzione *Avellino*, **Figura 3** e **Figura 4** riportano la somma dei passaggi totali sia orari che giornalieri. Come si puo' vedere dalla **Figura 4**, la corsia con il piu' alto numero di veicoli e' la *Corsia 3*, che e' quella di destra adiacente alla *Corsia 4* di sorpasso. Solo nel periodo festivo del mese di Agosto, possiamo vedere che la *Corsia 4* e' quella con il piu' alto numero di passaggi di autoveicoli.

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 3.** Serie temporale oraria del numero di passaggi per tutti i tipi di autoveicoli sull'autostrada A2 (km5+004) direzione Avellino"}


## A2 Direzione Avellino (Discendente)

Corsia_1D <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 1 & direzione == "D")
names(Corsia_1D)[names(Corsia_1D) == 'passaggi_totali'] <- 'passaggi_totali_corsia_1_DIS'

Corsia_2D <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 2 & direzione == "D")
names(Corsia_2D)[names(Corsia_2D) == 'passaggi_totali'] <- 'passaggi_totali_corsia_2_DIS'

Corsia_3D <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 3 & direzione == "D")
names(Corsia_3D)[names(Corsia_3D) == 'passaggi_totali'] <- 'passaggi_totali_corsia_3_DIS'

Corsia_4D <- DB %>%
  select(date,
         corsia,
         direzione,
         passaggi_totali) %>%
  filter(corsia == 4 & direzione == "D")
names(Corsia_4D)[names(Corsia_4D) == 'passaggi_totali'] <- 'passaggi_totali_corsia_4_DIS'

# join all data together
All_Corsie_DISCENDENTI <- Corsia_1D %>%
  left_join(Corsia_2D, by = "date")
All_Corsie_DISCENDENTI <- All_Corsie_DISCENDENTI %>%
  left_join(Corsia_3D, by = "date")
All_Corsie_DISCENDENTI <- All_Corsie_DISCENDENTI %>%
  left_join(Corsia_4D, by = "date")


# Build timeseries for plots
ts_TOT_passaggi <- data_frame_to_timeseries(All_Corsie_DISCENDENTI %>%
                                               select(date,
                                                      passaggi_totali_corsia_1_DIS,
                                                      passaggi_totali_corsia_2_DIS,
                                                      passaggi_totali_corsia_3_DIS,
                                                      passaggi_totali_corsia_4_DIS))

ts <- cbind(ts_TOT_passaggi$passaggi_totali_corsia_1_DIS, 
            ts_TOT_passaggi$passaggi_totali_corsia_2_DIS,
            ts_TOT_passaggi$passaggi_totali_corsia_3_DIS,
            ts_TOT_passaggi$passaggi_totali_corsia_4_DIS)

names(ts) <- c("counts_corsia_1_DIS",
                "counts_corsia_2_DIS",
                "counts_corsia_3_DIS",
                "counts_corsia_4_DIS")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Avellino - Discendente (conteggi totali)") %>% 
    dygraphs::dySeries("counts_corsia_1_DIS",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("counts_corsia_2_DIS",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("counts_corsia_3_DIS",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("counts_corsia_4_DIS",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "Conteggi totali") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

```


*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Figura 4.** Serie temporale della somma giornaliera di tutti i passaggi sull'autostrada A2 (km5+004) direzione Avellino La somma e' riferita a tutti i tipi di autoveicoli."}

# make dailiy SUMS
Daily_All_Corsie_DISCENDENTE <- data.frame(timeAverage(mydata   = All_Corsie_DISCENDENTI,
                                    avg.time   = "day", statistic  = "sum"))
            #start.date = round(min(DF$General$date, na.rm = TRUE), units = "hours"), 
            # end.date   = round(max(DF$General$date, na.rm = TRUE), units = "hours")))
                

# Build timeseries for plots
ts_TOT_passaggi <- data_frame_to_timeseries(Daily_All_Corsie_DISCENDENTE %>%
                                               select(date,
                                                      passaggi_totali_corsia_1_DIS,
                                                      passaggi_totali_corsia_2_DIS,
                                                      passaggi_totali_corsia_3_DIS,
                                                      passaggi_totali_corsia_4_DIS))

ts <- cbind(ts_TOT_passaggi$passaggi_totali_corsia_1_DIS, 
            ts_TOT_passaggi$passaggi_totali_corsia_2_DIS,
            ts_TOT_passaggi$passaggi_totali_corsia_3_DIS,
            ts_TOT_passaggi$passaggi_totali_corsia_4_DIS)

names(ts) <- c("counts_corsia_1_DIS",
                "counts_corsia_2_DIS",
                "counts_corsia_3_DIS",
                "counts_corsia_4_DIS")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (Somma passaggi giornalieri)")  %>% 
    dygraphs::dySeries("counts_corsia_1_DIS",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("counts_corsia_2_DIS",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("counts_corsia_3_DIS",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("counts_corsia_4_DIS",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "Somma conteggi totali") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
# plot
# frameWidget(plot, height = 500, width = '95%')

```

*<br/><br/>*

## 2. Analisi di conteggi per classe di veicoli

Il conteggio totale dei passaggi di tutti i veicoli sul tratto dell'autostrada A2 in esame e' stato analizzato per classe di veicoli. 
Come si puo' vedere dalla **Figura 5**, il numero totale di passaggi per classe di autoveicoli e' stato riportato assieme alla sua frazione percentale rispetto al numero totale di veicoli (di tutte le classi). Figura 5 mostra chiaramente che le *auto* rappresentanto circa il 77% del traffico totale, seguito da *autotreni* (~ 7%) e *furgoni*
(~ 6%). I mezzi *articolati* rappresentano circa il 4% del traffico veicolare. Invece, la frazione di veicoli con meno del 2% della presenza e' rappresentato da *camion* di lunghezza maggiore/minore di 7.5m.

Analizzando il numero **mensile** di passaggi effettuato per le classi di veicoli piu' significative, vediamo che il mese di *Agosto* e' quello che presenta il numero di passaggi piu' elevato per la classe delle *auto* con circa l'80% di tutto il traffico veicolare in entrambe le direzioni (**Figura 6**). Da notare che **i mesi di Gennaio, Febbraio e Dicembre non sono rappresentativi del traffico veicolare per il periodo in esame poiche' ci sono molti dati mancanti**.
Per i rimanenti mesi dell'anno, potremmo concludere che il traffico pesante e' equamente distribuito nei mesi in esame. 

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 5.** Numero di passaggi totali per classe di autoveicoli sul tratto dell'autostrada A2 (km5+004). I numeri all'interno del grafico indicano la distribuzione percentuale per classi di veicolo del numero di passaggi sulle due direzioni di marcia: --> Salerno e <-- Avellino."}

########################
### summary stats ######
########################


## get the months of observations
DB$month <- factor(format(DB$date, format = "%b"), levels = month.abb)

# get all names for speficic classes
all_passaggi <- names(DB[grep(pattern  = "passaggi", x = names(DB))])
all_passaggi_idx <- which(names(DB) %in%  names(DB[grep(pattern  = "passaggi", x = names(DB))]) )
# select only "passaggi"
DB_passaggi <- DB[all_passaggi]
# add corsia and direzione
DB_passaggi <- cbind(DB_passaggi, DB$corsia, DB$direzione)
names(DB_passaggi) <- c(all_passaggi, "corsia", "direzione")
# transpose data
passaggi <- gather(DB_passaggi, "classi", "records", 1:length(all_passaggi))
passaggi$records <- as.numeric(passaggi$records)

# somma di tutti i tipi di conteggi per i passaggi di veicoli
STATS_passaggi <- passaggi %>%
  group_by( #corsia,
           direzione,
           classi) %>%
  summarise(conteggi_totali = sum(records, na.rm = TRUE))

STATS_passaggi$classi <- as.factor(STATS_passaggi$classi)
# change "passaggi with "N
levels(STATS_passaggi$classi) <- gsub("passaggi_totali","N", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("classe_di_velocita_","", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("__","_", levels(STATS_passaggi$classi))
levels(STATS_passaggi$direzione) <- gsub("A","--> Salerno", levels(STATS_passaggi$direzione))
levels(STATS_passaggi$direzione) <- gsub("D","<-- Avellino", levels(STATS_passaggi$direzione))

to_keep <- as.vector( STATS_passaggi$classi[-grep(pattern  = "\\_km_h\\b", x = STATS_passaggi$classi)])

# remove not neccessary informations for the counts (conteggi totali)
# only keep the "conteggi" by classe
STATS_passaggi <- STATS_passaggi %>%
  filter(!classi %in% c("N_conteggio", "N_altri", "N_auto_rimorchio")) %>%
  filter(classi %in% to_keep)

## get number all all vehicles by pecentage
# normalize all "passaggi" to the "classe" N
STATS_passaggi <- STATS_passaggi %>%
  group_by(direzione) %>%
  mutate(norm_conteggi = (conteggi_totali/conteggi_totali[1])*100)
STATS_passaggi$norm_conteggi <- round(STATS_passaggi$norm_conteggi, digits = 1)


STATS_passaggi <- STATS_passaggi[order(-STATS_passaggi$conteggi_totali),]
STATS_passaggi <- STATS_passaggi[order(-STATS_passaggi$norm_conteggi),]
# remove rows with 0 values
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$conteggi_totali == 0), ]
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$norm_conteggi == 0), ]
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$norm_conteggi == 100), ]
levels(STATS_passaggi$classi) <- gsub("N_","", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("\\camion_7_5m\\b","camion < 7.5m", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("\\camion_7_5m_1\\b", "camion > 7.5m", levels(STATS_passaggi$classi))

STATS_passaggi <- as.data.frame(STATS_passaggi)
STATS_passaggi$classi <- as.character(STATS_passaggi$classi)

categories <- as.character( unique(STATS_passaggi$classi))

### plot passaggi #####
#######################

q <- ggplot(data = STATS_passaggi,
            aes(classi, conteggi_totali, fill = direzione)) +
  theme_bw() +
  geom_bar(stat = "identity", position = position_stack()) +
  scale_x_discrete(limits = categories) +
  geom_text_repel(aes(label=norm_conteggi), vjust=1, color="black",
            position = position_stack(0.85), size=4)+
  theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1, size=11)) +
  theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +
  ylab(expression(paste("numero di passaggi (a.u)"))) +
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
  ggtitle("Numero di passaggi totali (tutti i veicoli, 2017-2018)") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5))
q

```

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5}


# ### plot passaggi by % pecentage #####
# ######################################
# 
# q <- ggplot(data = STATS_passaggi, 
#             aes(classi, norm_conteggi, fill = direzione)) +
#   theme_bw() +
#   geom_bar(stat = "identity", position = position_stack()) +
#   scale_x_discrete(limits = categories) + 
#   geom_text_repel(aes(label=norm_conteggi), vjust=1, color="black",
#             position = position_stack(0.85), size=4)+
#   theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
#   theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1, size=11)) +
#   theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
#   theme(axis.title.x = element_blank()) +                                     
#   ylab(expression(paste("percentuale di passaggi (%)"))) + 
#   theme(axis.title.y = element_text(face="bold", colour="black", size=12),
#         axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
#   ggtitle("Passaggi totali relativi (tutti i veicoli - 2017-2018)") + 
#   theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5)) 
# q


```



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=6,  fig.cap ="**Figura 6.** Numero mensile di passaggi totali per classe di autoveicoli sul tratto dell'autostrada A2 (km5+004). I numeri all'interno del grafico indicano la distribuzione percentuale, per classi di veicolo, del numero di passaggi sulle due direzioni di marcia: --> Salerno & <-- Avellino. I mesi di Gennaio, Febbraio e Dicembre non sono rappresentativi a causa dell'incompletezza dei dati"}

## organize data by months

## get the months of observations
DB$month <- factor(format(DB$date, format = "%b"), levels = month.abb)

# get all names for speficic classes
all_passaggi <- names(DB[grep(pattern  = paste(c("passaggi", "month"), collapse = "|"), x = names(DB))])
all_passaggi_idx <- which(names(DB) %in%  names(DB[grep(pattern  = paste(c("passaggi", "month"), collapse = "|"), x = names(DB))]) )
# select only "passaggi"
DB_passaggi <- DB[all_passaggi]

# add corsia and direzione
DB_passaggi <- cbind(DB_passaggi, DB$corsia, DB$direzione)
names(DB_passaggi) <- c(all_passaggi, "corsia", "direzione")

# transpose data
passaggi <- gather(DB_passaggi, "classi", "records", 1:(length(all_passaggi)-1))
passaggi$records <- as.numeric(passaggi$records)

passaggi$classi <- as.factor(passaggi$classi)
# make classe "articolati" as classe "Autotreni"
levels(passaggi$classi) <- gsub("passaggi_totali_articolati","passaggi_totali_autotreni", levels(passaggi$classi))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
STATS_passaggi_monthly <- passaggi %>%
  group_by( #corsia,
           direzione,
           classi,
           month) %>%
  summarise(conteggi_totali = sum(records, na.rm = TRUE))


STATS_passaggi_monthly$classi <- as.factor(STATS_passaggi_monthly$classi)
# change "passaggi with "N
levels(STATS_passaggi_monthly$classi) <- gsub("passaggi_totali","N", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$classi) <- gsub("classe_di_velocita_","", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$classi) <- gsub("__","_", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$direzione) <- gsub("A","--> Salerno", levels(STATS_passaggi_monthly$direzione))
levels(STATS_passaggi_monthly$direzione) <- gsub("D","<-- Avellino", levels(STATS_passaggi_monthly$direzione))

to_keep <- as.vector( STATS_passaggi_monthly$classi[-grep(pattern  = "\\_km_h\\b", x = STATS_passaggi_monthly$classi)])

# remove not neccessary informations for the counts (conteggi totali)
# only keep the "conteggi" by classe 
STATS_passaggi_monthly <- STATS_passaggi_monthly %>%
  filter(classi %in% to_keep) 
STATS_passaggi_monthly <- STATS_passaggi_monthly %>%
  filter(!classi %in% c("N_conteggio", "N_altri", "N_camion_7_5m", "N_camion_7_5m_1", "N_auto_rimorchio",
                        "N_autobus", "N_moto"))  

STATS_passaggi_monthly <- as.data.frame(STATS_passaggi_monthly)

## get number all all vehicles by pecentage
# normalize all "passaggi" to the "classe" N
STATS_passaggi_monthly <- STATS_passaggi_monthly %>%
  group_by(direzione,
           month) %>%
  mutate(norm_conteggi = (conteggi_totali/conteggi_totali[1])*100)
STATS_passaggi_monthly$norm_conteggi <- round(STATS_passaggi_monthly$norm_conteggi, digits = 1)

 
STATS_passaggi_monthly <- STATS_passaggi_monthly[order(-STATS_passaggi_monthly$conteggi_totali),]
STATS_passaggi_monthly <- STATS_passaggi_monthly[order(-STATS_passaggi_monthly$norm_conteggi),]
# remove rows with 0 values
STATS_passaggi_monthly <- STATS_passaggi_monthly[!(STATS_passaggi_monthly$conteggi_totali == 0), ]
STATS_passaggi_monthly <- STATS_passaggi_monthly[!(STATS_passaggi_monthly$norm_conteggi == 0), ]
STATS_passaggi_monthly <- STATS_passaggi_monthly[!(STATS_passaggi_monthly$norm_conteggi == 100), ]
levels(STATS_passaggi_monthly$classi) <- gsub("N_","", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$classi) <- gsub("\\camion_7_5m\\b","camion < 7.5m", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$classi) <- gsub("\\camion_7_5m_1\\b", "camion > 7.5m", levels(STATS_passaggi_monthly$classi))
levels(STATS_passaggi_monthly$classi) <- gsub("autotreni","autotreni & artic.", levels(STATS_passaggi_monthly$classi))

STATS_passaggi_monthly <- as.data.frame(STATS_passaggi_monthly)
STATS_passaggi_monthly$classi <- as.character(STATS_passaggi_monthly$classi)

categories <- as.character( unique(STATS_passaggi_monthly$classi))

### plot passaggi by % pecentage and by MONTH #####
###################################################


plot <- ggplot(STATS_passaggi_monthly, aes(month, conteggi_totali, fill = direzione)) +
  theme_bw() +
  facet_grid(classi ~ .) +
  # ylim(0, 250) +
  theme( strip.text = element_text(size = 12)) +
  geom_bar(stat = "identity", position = position_stack()) +
  # scale_x_discrete(limits = categories) + 
  geom_text_repel(aes(label=norm_conteggi), vjust=1, color="black",
            position = position_stack(0.5), size=3)+
  theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
  theme(axis.text.x=element_text(angle=0,hjust=0.5,vjust=1, size=12)) +
  theme(axis.text.x=element_text(size=12,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                                     
  ylab(expression(paste("numero di passaggi"))) + 
  theme(axis.title.y = element_text(face="bold", colour="black", size=10),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=10, colour="black")) +
  ggtitle("numero totale di passaggi per mese (2017-2018)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5)) 
plot


```

*<br/><br/>*

Il numero totale di passaggi di veicoli e la loro distribuzione percentuale per classi e per corsia di marcia, sono rappresentati in **Figura 7**. Come si puo' vedere, le auto sono quasi sempre equamente presenti sia sulla corsia di *"destra"* che su quella di *"sinistra" o "sorpasso"*. Quindi possiamo stimare che l'82% di tutti i passagi di auto si trovi sulla corsia di *sorpasso* mentre il 71% su quella di "destra". Invece, gli autotreni e gli articolati si trovano in percentuale maggiore sulla corsia di *destra* con il 14% di tutti i passaggi rispetto al 7% dei passaggi che sono stati registrati sulla corsia di *sorpasso*. Le stesse valutazioni possono essere fatte per camion, moto e furgoni.

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=6, fig.cap ="**Figura 7.** Numero totale di passaggi per classe di autoveicoli e per corsia di marcia sul tratto dell'autostrada A2 (km5+004). I numeri all'interno del grafico indicano la distribuzione percentuale, per classi di veicolo."}

########################
### summary stats ######
########################

# 
# ## get the months of observations
# DB$month <- factor(format(DB$date, format = "%b"), levels = month.abb)
# 
# # get all names for speficic classes
# all_passaggi <- names(DB[grep(pattern  = "passaggi", x = names(DB))])
# all_passaggi_idx <- which(names(DB) %in%  names(DB[grep(pattern  = "passaggi", x = names(DB))]) )
# # select only "passaggi"
# DB_passaggi <- DB[all_passaggi]
# # add corsia and direzione
# DB_passaggi <- cbind(DB_passaggi, DB$corsia, DB$direzione)
# names(DB_passaggi) <- c(all_passaggi, "corsia", "direzione")
# # transpose data
# passaggi <- gather(DB_passaggi, "classi", "records", 1:length(all_passaggi))
# passaggi$records <- as.numeric(passaggi$records)

# make "articolati" as the same class of "autotreni"
passaggi$classi <- as.factor(passaggi$classi)
levels(passaggi$classi) <- gsub("__articolati","__autotreni", levels(passaggi$classi))

# somma di tutti i tipi di conteggi per i passaggi di veicoli
STATS_passaggi <- passaggi %>%
  group_by(corsia,
           direzione,
           classi) %>%
  summarise(conteggi_totali = sum(records, na.rm = TRUE))

STATS_passaggi$classi <- as.factor(STATS_passaggi$classi)
# change "passaggi with "N
levels(STATS_passaggi$classi) <- gsub("passaggi_totali","N", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("classe_di_velocita_","", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("__","_", levels(STATS_passaggi$classi))

levels(STATS_passaggi$direzione) <- gsub("A","--> Salerno", levels(STATS_passaggi$direzione))
levels(STATS_passaggi$direzione) <- gsub("D","<-- Avellino", levels(STATS_passaggi$direzione))

to_keep <- as.vector( STATS_passaggi$classi[-grep(pattern  = "\\_km_h\\b", x = STATS_passaggi$classi)])

# remove not neccessary informations for the counts (conteggi totali)
# only keep the "conteggi" by classe 
STATS_passaggi <- STATS_passaggi %>%
  filter(!classi %in% c("N_conteggio", "N_altri", "N_auto_rimorchio")) %>%
  filter(classi %in% to_keep)

## get number all all vehicles by pecentage
# normalize all "passaggi" to the "classe" N
STATS_passaggi <- STATS_passaggi %>%
  group_by(direzione,
           corsia) %>%
  mutate(norm_conteggi = (conteggi_totali/conteggi_totali[1])*100)
STATS_passaggi$norm_conteggi <- round(STATS_passaggi$norm_conteggi, digits = 1)
STATS_passaggi$conteggi_totali <- round(STATS_passaggi$conteggi_totali, digits = 0)

 
STATS_passaggi <- STATS_passaggi[order(-STATS_passaggi$conteggi_totali),]
STATS_passaggi <- STATS_passaggi[order(-STATS_passaggi$norm_conteggi),]
# remove rows with 0 values
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$conteggi_totali == 0), ]
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$norm_conteggi == 0), ]
STATS_passaggi <- STATS_passaggi[!(STATS_passaggi$norm_conteggi == 100), ]
levels(STATS_passaggi$classi) <- gsub("N_","", levels(STATS_passaggi$classi))

levels(STATS_passaggi$classi) <- gsub("N_","", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("\\camion_7_5m\\b","camion < 7.5m", levels(STATS_passaggi$classi))
levels(STATS_passaggi$classi) <- gsub("\\camion_7_5m_1\\b", "camion > 7.5m", levels(STATS_passaggi$classi))

levels(STATS_passaggi$classi) <- gsub("autotreni","autotreni & artic.", levels(STATS_passaggi$classi))

STATS_passaggi <- as.data.frame(STATS_passaggi)
STATS_passaggi$classi <- as.character(STATS_passaggi$classi)


STATS_passaggi$corsia <- as.factor(STATS_passaggi$corsia)
levels(STATS_passaggi$corsia) <- gsub("1","corsia 1", levels(STATS_passaggi$corsia))
levels(STATS_passaggi$corsia) <- gsub("2","corsia 2", levels(STATS_passaggi$corsia))
levels(STATS_passaggi$corsia) <- gsub("3","corsia 3", levels(STATS_passaggi$corsia))
levels(STATS_passaggi$corsia) <- gsub("4","corsia 4", levels(STATS_passaggi$corsia))

categories <- as.character( unique(STATS_passaggi$classi))

### plot passaggi #####
#######################

### plot OCCUPAZIONE #####
##########################

q <- ggplot(data = STATS_passaggi, 
            aes(classi, conteggi_totali, fill = classi)) +
    theme_bw() +
  geom_bar(stat = "identity") + 
  facet_grid(corsia ~ direzione, scales = "free_y", space = "free") +
  theme(strip.text.x = element_text(size = 13, colour = "black")) +
  guides(fill=FALSE) +
  # scale_fill_manual(values=c("#7f7fff", "#7fbf7f", "#ff0000", "#e5e500", "#8e8e8e")) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1, size=11)) +
  theme(axis.text.x=element_text(size=10,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                                     
  ylab("Passaggi") +   
  ylim(0, 3600000) +
   theme(axis.title.y = element_text(face="bold", colour="black", size=10),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=10, colour="black")) +
  geom_text(aes(label = paste(round(norm_conteggi), sep = "")), size = 3, hjust = 0.5, vjust = -0.5) +
  ggtitle("Numero totale di passaggi per corsia di marcia e per classi di autoveicoli (2017-2018)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 14))
q

```


*<br/><br/>*

## 3. Analisi della velocita' media ed armonica per classe di veicoli

La velocita' media di tutti i veicoli in transito sul tratto in esame dell'autostrada A2 in direzione Salerno sono rappresentati in **Figura 8**. Come si puo' notare, le velocita' piu' alte (> 110 km/h) sono state tutte regitrate sulla *Corsia 2* di *"sorpasso"*, mentre velocita' <= 90 km/h sono state quasi tutte registrate sulla corsia di *"destra"*. E' da notare che nel grafico di Figura 8 sono anche visibili degli *"outliers"* rappresentati da veicoli che viaggiano a velocita' di gran lunga al di sopra dei limiti consentiti dalla legge (max 130 km/h). Come si vede, questi *"outliers"* sono riferiti a velocita' di circa 180 - 200 km/h. Anche in direzione Avellino (**Figura 9**) le velocta' piu' alte sono state registrate sulla *Corsia 4* di "sorpasso" con velocita' medie orarie di circa 120 km/h, mentre la sulla *Corsia 3* di "destra" sono state registrate velocita' di circa 100 km/h. Si potrebbe tentativamente dedurre che, nella direzione verso Salerno, si viaggia ad una veloctia' leggermente minore (di circa 10 km/h) rispetto alla direzione verso Avellino.  

*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5, fig.cap ="**Figura 8.** Velocita' media oraria e per corsia di marcia di tutti i veicoli in transito sul tratto dell'autostrada A2 (km5+004) direzione Salerno."}


DB_2017[(nrow(DB_2017)-8): nrow(DB_2017), ][names(DB_2017) == 'Velocita..Media..Km.h.'] <- 0

# get first 8 lines of DB_2018 and set them to 0  (4*2, ASCEDNDENTI & DISCENDENTI)
DB_2018[1:8, ][names(DB_2018) == 'Velocita..Media..Km.h.'] <- 0

# Bind and perform data cleaning
DB <- rbind(DB_2017, DB_2018)

headers <- names(DB)
headers <- str_replace_all(headers, "\\.|\\(|\\)", "_")
headers <- make.names(headers, unique = TRUE)
headers <- str_replace_all(headers, "\\.", "_")
headers <- str_to_lower(headers)

# Give table headers
names(DB) <- headers

# format DateTime
DB$riferimento_temporale <- lubridate::dmy_hms(DB$riferimento_temporale, tz = "UTC")
DB$fine_periodo_di_aggregazione <- lubridate::dmy_hms(DB$fine_periodo_di_aggregazione, tz = "UTC")


#########################################
## Quick dynamic time series ############
#########################################

## A2 Direzione Salerno (Ascendente)

names(DB)[names(DB) == 'fine_periodo_di_aggregazione'] <- 'date'

Corsia_1A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 1 & direzione == "A")
names(Corsia_1A)[names(Corsia_1A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_1_ASC'


Corsia_2A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 2 & direzione == "A")
names(Corsia_2A)[names(Corsia_2A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_2_ASC'

Corsia_3A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 3 & direzione == "A")
names(Corsia_3A)[names(Corsia_3A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_3_ASC'

Corsia_4A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 4 & direzione == "A")
names(Corsia_4A)[names(Corsia_4A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_4_ASC'

# join all data together
All_Corsie_ASCENDENTI <- Corsia_1A %>%
  left_join(Corsia_2A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_3A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_4A, by = "date")


# Build timeseries for plots
ts_TOT_velocita_media <- data_frame_to_timeseries(All_Corsie_ASCENDENTI %>%
                                               select(date,
                                                      velocita_media_corsia_1_ASC,
                                                      velocita_media_corsia_2_ASC,
                                                      velocita_media_corsia_3_ASC,
                                                      velocita_media_corsia_4_ASC))

ts <- cbind(ts_TOT_velocita_media$velocita_media_corsia_1_ASC, 
            ts_TOT_velocita_media$velocita_media_corsia_2_ASC,
            ts_TOT_velocita_media$velocita_media_corsia_3_ASC,
            ts_TOT_velocita_media$velocita_media_corsia_4_ASC)

names(ts) <- c("velocita_media_corsia_1_ASC",
                "velocita_media_corsia_2_ASC",
                "velocita_media_corsia_3_ASC",
                "velocita_media_corsia_4_ASC")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (velocita' media di tutti i veicoli)")  %>% 
    dygraphs::dySeries("velocita_media_corsia_1_ASC",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("velocita_media_corsia_2_ASC",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("velocita_media_corsia_3_ASC",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("velocita_media_corsia_4_ASC",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "velocita' media") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

```

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5}

# # make dailiy averages
# Daily_All_Corsie_ASCENDENTI <- data.frame(timeAverage(mydata   = All_Corsie_ASCENDENTI,
#                                     avg.time   = "day", statistic  = "mean"))
# 
# # Build timeseries for plots
# ts_TOT_velocita_media <- data_frame_to_timeseries(Daily_All_Corsie_ASCENDENTI %>%
#                                                select(date,
#                                                       velocita_media_corsia_1_ASC,
#                                                       velocita_media_corsia_2_ASC,
#                                                       velocita_media_corsia_3_ASC,
#                                                       velocita_media_corsia_4_ASC))
# 
# ts <- cbind(ts_TOT_velocita_media$velocita_media_corsia_1_ASC, 
#             ts_TOT_velocita_media$velocita_media_corsia_2_ASC,
#             ts_TOT_velocita_media$velocita_media_corsia_3_ASC,
#             ts_TOT_velocita_media$velocita_media_corsia_4_ASC)
# 
# names(ts) <- c("velocita_media_corsia_1_ASC",
#                 "velocita_media_corsia_2_ASC",
#                 "velocita_media_corsia_3_ASC",
#                 "velocita_media_corsia_4_ASC")
# 
# 
# plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (velocita' media giornaliera)")  %>% 
#     dygraphs::dySeries("velocita_media_corsia_1_ASC",label = "corsia 1", color = "red") %>%
#     dygraphs::dySeries("velocita_media_corsia_2_ASC",label = "corsia 2", color = "blue") %>%
#     dygraphs::dySeries("velocita_media_corsia_3_ASC",label = "corsia 3", color = "black") %>%
#     dygraphs::dySeries("velocita_media_corsia_4_ASC",label = "corsia 4", color = "orange") %>%
#     dyAxis("y", label = "velocita' media") %>% 
#     dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
#     dyRangeSelector()
# plot

```



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5, fig.cap ="**Figura 9.** Velocita' media oraria e per corsia di marcia di tutti i veicoli in transito sul tratto dell'autostrada A2 (km5+004) direzione Avellino."}


## A2 Direzione Avellino (Discendente)

Corsia_1A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 1 & direzione == "D")
names(Corsia_1A)[names(Corsia_1A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_1_DIS'


Corsia_2A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 2 & direzione == "D")
names(Corsia_2A)[names(Corsia_2A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_2_DIS'

Corsia_3A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 3 & direzione == "D")
names(Corsia_3A)[names(Corsia_3A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_3_DIS'

Corsia_4A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media__km_h_) %>%
  filter(corsia == 4 & direzione == "D")
names(Corsia_4A)[names(Corsia_4A) == 'velocita__media__km_h_'] <- 'velocita_media_corsia_4_DIS'

# join all data together
All_Corsie_DISCENDENTI <- Corsia_1A %>%
  left_join(Corsia_2A, by = "date")
All_Corsie_DISCENDENTI <- All_Corsie_DISCENDENTI %>%
  left_join(Corsia_3A, by = "date")
All_Corsie_DISCENDENTI <- All_Corsie_DISCENDENTI %>%
  left_join(Corsia_4A, by = "date")


# Build timeseries for plots
ts_TOT_velocita_media <- data_frame_to_timeseries(All_Corsie_DISCENDENTI %>%
                                               select(date,
                                                      velocita_media_corsia_1_DIS,
                                                      velocita_media_corsia_2_DIS,
                                                      velocita_media_corsia_3_DIS,
                                                      velocita_media_corsia_4_DIS))

ts <- cbind(ts_TOT_velocita_media$velocita_media_corsia_1_DIS, 
            ts_TOT_velocita_media$velocita_media_corsia_2_DIS,
            ts_TOT_velocita_media$velocita_media_corsia_3_DIS,
            ts_TOT_velocita_media$velocita_media_corsia_4_DIS)

names(ts) <- c("velocita_media_corsia_1_DIS",
                "velocita_media_corsia_2_DIS",
                "velocita_media_corsia_3_DIS",
                "velocita_media_corsia_4_DIS")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Avellino (velocita' media di tutti i veicoli)")  %>% 
    dygraphs::dySeries("velocita_media_corsia_1_DIS",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("velocita_media_corsia_2_DIS",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("velocita_media_corsia_3_DIS",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("velocita_media_corsia_4_DIS",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "velocita' media") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

```

\newline
\newline

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5}

# # make dailiy averages
# Daily_All_Corsie_DISCENDENTE <- data.frame(timeAverage(mydata   = All_Corsie_DISCENDENTI,
#                                     avg.time   = "day", statistic  = "mean"))
# 
# # Build timeseries for plots
# ts_TOT_velocita_media <- data_frame_to_timeseries(Daily_All_Corsie_DISCENDENTE %>%
#                                                select(date,
#                                                       velocita_media_corsia_1_DIS,
#                                                       velocita_media_corsia_2_DIS,
#                                                       velocita_media_corsia_3_DIS,
#                                                       velocita_media_corsia_4_DIS))
# 
# ts <- cbind(ts_TOT_velocita_media$velocita_media_corsia_1_DIS, 
#             ts_TOT_velocita_media$velocita_media_corsia_2_DIS,
#             ts_TOT_velocita_media$velocita_media_corsia_3_DIS,
#             ts_TOT_velocita_media$velocita_media_corsia_4_DIS)
# 
# names(ts) <- c("velocita_media_corsia_1_DIS",
#                 "velocita_media_corsia_2_DIS",
#                 "velocita_media_corsia_3_DIS",
#                 "velocita_media_corsia_4_DIS")
# 
# 
# plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Avellino (velocita' media giornaliera)")  %>% 
#     dygraphs::dySeries("velocita_media_corsia_1_DIS",label = "corsia 1", color = "red") %>%
#     dygraphs::dySeries("velocita_media_corsia_2_DIS",label = "corsia 2", color = "blue") %>%
#     dygraphs::dySeries("velocita_media_corsia_3_DIS",label = "corsia 3", color = "black") %>%
#     dygraphs::dySeries("velocita_media_corsia_4_DIS",label = "corsia 4", color = "orange") %>%
#     dyAxis("y", label = "velocita' media") %>% 
#     dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
#     dyRangeSelector()
# plot

```

*<br/><br/>*

Riportiamo anche la velocita' armonica per tutti i tipi di veicoli in transito sul tratto in esame dell' autostrada A2. Brevemente, la *velocita' armonica* puo' essere definita come la **velocita' costante** alla quale ogni veicolo dovrebbe muoversi sul tratto di strada in esame in modo tale che i tempi di percorrenza nelle due direzioni siano uguali. **Figura 10** mostra l'andamento temporale della velocita' media armonica per diverse classi di veicoli. Per evitare informazioni ridondanti, mostriamo solo la velocita' armonica nella direzione verso Salerno. Come si puo' vedere dalla Figura 10, la velocita' armonica sulla *Corsia 1* e *Corsia 2* in direzione Salerno e' leggermente inferiore alla velocita' media registrata sulle stesse corsie (110 e 90 km/h) e con valori che raggiungono circa 105 km/h e 85 km/h, rispettivamente. 

*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5, fig.cap ="**Figura 10.** Velocita' armonica oraria e per corsia di marcia di tutti i veicoli in transito sul tratto dell'autostrada A2 (km5+004) direzione Salerno."}

## velocita' armonica
DB_2017[(nrow(DB_2017)-8): nrow(DB_2017), ][names(DB_2017) == 'Velocita..Media.Armonica..Km.h.'] <- 0

# get first 8 lines of DB_2018 and set them to 0  (4*2, ASCEDNDENTI & DISCENDENTI)
DB_2018[1:8, ][names(DB_2018) == 'Velocita..Media.Armonica..Km.h.'] <- 0

# Bind and perform data cleaning
DB <- rbind(DB_2017, DB_2018)

headers <- names(DB)
headers <- str_replace_all(headers, "\\.|\\(|\\)", "_")
headers <- make.names(headers, unique = TRUE)
headers <- str_replace_all(headers, "\\.", "_")
headers <- str_to_lower(headers)

# Give table headers
names(DB) <- headers

# format DateTime
DB$riferimento_temporale <- lubridate::dmy_hms(DB$riferimento_temporale, tz = "UTC")
DB$fine_periodo_di_aggregazione <- lubridate::dmy_hms(DB$fine_periodo_di_aggregazione, tz = "UTC")


#########################################
## Quick dynamic time series ############
#########################################

## A2 Direzione Salerno (Ascendente)

names(DB)[names(DB) == 'fine_periodo_di_aggregazione'] <- 'date'

Corsia_1A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media_armonica__km_h_) %>%
  filter(corsia == 1 & direzione == "A")
names(Corsia_1A)[names(Corsia_1A) == 'velocita__media_armonica__km_h_'] <- 'velocita_armonica_corsia_1_ASC'


Corsia_2A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media_armonica__km_h_) %>%
  filter(corsia == 2 & direzione == "A")
names(Corsia_2A)[names(Corsia_2A) == 'velocita__media_armonica__km_h_'] <- 'velocita_armonica_corsia_2_ASC'

Corsia_3A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media_armonica__km_h_) %>%
  filter(corsia == 3 & direzione == "A")
names(Corsia_3A)[names(Corsia_3A) == 'velocita__media_armonica__km_h_'] <- 'velocita_armonica_corsia_3_ASC'

Corsia_4A <- DB %>%
  select(date,
         corsia,
         direzione,
         velocita__media_armonica__km_h_) %>%
  filter(corsia == 4 & direzione == "A")
names(Corsia_4A)[names(Corsia_4A) == 'velocita__media_armonica__km_h_'] <- 'velocita_armonica_corsia_4_ASC'

# join all data together
All_Corsie_ASCENDENTI <- Corsia_1A %>%
  left_join(Corsia_2A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_3A, by = "date")
All_Corsie_ASCENDENTI <- All_Corsie_ASCENDENTI %>%
  left_join(Corsia_4A, by = "date")


# Build timeseries for plots
ts_TOT_velocita_armonica <- data_frame_to_timeseries(All_Corsie_ASCENDENTI %>%
                                               select(date,
                                                      velocita_armonica_corsia_1_ASC,
                                                      velocita_armonica_corsia_2_ASC,
                                                      velocita_armonica_corsia_3_ASC,
                                                      velocita_armonica_corsia_4_ASC))

ts <- cbind(ts_TOT_velocita_armonica$velocita_armonica_corsia_1_ASC, 
            ts_TOT_velocita_armonica$velocita_armonica_corsia_2_ASC,
            ts_TOT_velocita_armonica$velocita_armonica_corsia_3_ASC,
            ts_TOT_velocita_armonica$velocita_armonica_corsia_4_ASC)

names(ts) <- c("velocita_armonica_corsia_1_ASC",
                "velocita_armonica_corsia_2_ASC",
                "velocita_armonica_corsia_3_ASC",
                "velocita_armonica_corsia_4_ASC")


plot <- dygraph(ts, main = "A2 (Km 5+004) direzione Salerno (velocita' media ARMONICA di tutti i veicoli)")  %>% 
    dygraphs::dySeries("velocita_armonica_corsia_1_ASC",label = "corsia 1", color = "red") %>%
    dygraphs::dySeries("velocita_armonica_corsia_2_ASC",label = "corsia 2", color = "blue") %>%
    dygraphs::dySeries("velocita_armonica_corsia_3_ASC",label = "corsia 3", color = "black") %>%
    dygraphs::dySeries("velocita_armonica_corsia_4_ASC",label = "corsia 4", color = "orange") %>%
    dyAxis("y", label = "velocita' media ARMONICA") %>% 
    dyOptions(useDataTimezone = TRUE) %>% # do not use the local time zone
    dyRangeSelector()
plot

```


*<br/><br/>*

La media delle velocita' medie orarie e delle velocita' armoniche, insieme alle deviazioni standard, sono state calcolate per tutte per le classi di veicoli che percorrono il tratto di autostrada A2 in esame. Come si puo' vedere dalla **Figura 11**, le velocita' medie piu' alte sono state registrate per le auto, seguite da furgoni e da autotreni/articolati. Per la direzione verso Salerno, le velocita' medie ed armoniche piu' elevate sono state registrate sulla *Corsia 2* di "sorpasso" con auto e furgoni avennti una velocita' media di ~ 100 km/h seguita da una velocita' media di 86 km/h per gli autotreni e gli articolati. Invece, esaminando la direzione verso Avellino, le velocita' piu' alte sono sempre state registrate sulla *Corsia 4* di "sorpasso' ma con dei valori leggermente elevati fino con una velocita' media che ha raggiunto i 108 km/h per auto e furgoni, seguita da una velocita' media di 95 km/h per gli autotreni e gli articolati. 
Come gia' osservato nelle serie temporali, il tratto di autostrada A2 presenta un flusso di veicoli con percorrenza piu' veloce nella direzione verso Avellino rispetto alla direzione verso Salerno. Inoltre, la deviazione standard della velocita' media nella direzione verso Avellino e' risultata piu' grande di quella osservata nella direzione verso Salerno. Questo potrebbe significare che c'e' una *variabilita'* maggiore del traffico veicolare nella direzione verso Avellino piuttosto che nella direzione verso Salerno.

*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=7, fig.cap ="**Figura 11.** Media delle velocita' medie ed armoniche per classe di autoveicoli e per corsia di marcia sul tratto dell'autostrada A2 (km5+004)."}


########################
### summary stats ######
########################

#######################
### Velocita' #########


## get the months of observations
DB$month <- factor(format(DB$date, format = "%b"), levels = month.abb)

# get all names for speficic classes of velocita'
all_velocita <- names(DB[grep(pattern  = "velocita", x = names(DB))])
DB_velocita <- DB[all_velocita]
# exclude all names the word containing "passaggi"
all_velocita <- names(DB_velocita[-grep(pattern  = "passaggi", x = names(DB_velocita))])
DB_velocita <- DB[all_velocita]
# add corsia and direzione
DB_velocita <- cbind(DB_velocita, DB$corsia, DB$direzione)
names(DB_velocita) <- c(all_velocita, "corsia", "direzione")
# transpose data
velocita <- gather(DB_velocita, "classi", "records", 1:length(all_velocita))
velocita$records <- as.numeric(velocita$records)
velocita$records <-  round(velocita$records, digits = 0)
# make "articolati" as the same class of "autotreni"
velocita$classi <- as.factor(velocita$classi)
levels(velocita$classi) <- gsub("__articolati","__autotreni", levels(velocita$classi))

#media di tutte le velocita' per ogni classe di veicolo di veicoli
velocita <- velocita[complete.cases(velocita), ] # Keep only the complete rows
# remove velocita' == 0
velocita <- velocita[!(velocita$records == 0), ]
STATS_velocita <- velocita %>%
  group_by(corsia,
           direzione,
           classi) %>%
  summarise(velocita_medie = mean(records, na.rm = TRUE)) 

STATS_velocita$classi <- as.factor(STATS_velocita$classi)
# change the structure of some strings
levels(STATS_velocita$classi) <- gsub("velocita__","", levels(STATS_velocita$classi))
levels(STATS_velocita$direzione) <- gsub("A","--> Salerno", levels(STATS_velocita$direzione))
levels(STATS_velocita$direzione) <- gsub("D","<-- Avellino", levels(STATS_velocita$direzione))
levels(STATS_velocita$classi) <- gsub("__km_h__","_", levels(STATS_velocita$classi))
levels(STATS_velocita$classi) <- gsub("__km_h_","", levels(STATS_velocita$classi))

STATS_velocita$corsia <- as.factor(STATS_velocita$corsia)
levels(STATS_velocita$corsia) <- gsub("1","corsia 1", levels(STATS_velocita$corsia))
levels(STATS_velocita$corsia) <- gsub("2","corsia 2", levels(STATS_velocita$corsia))
levels(STATS_velocita$corsia) <- gsub("3","corsia 3", levels(STATS_velocita$corsia))
levels(STATS_velocita$corsia) <- gsub("4","corsia 4", levels(STATS_velocita$corsia))

pattern_to_remove = paste(c("\\_conteggio\\b", "\\_altri\\b", "\\_camion__7_5m\\b", "\\_camion__7_5m_1\\b", "\\_auto_rimorchio\\b","\\_autobus\\b", "\\_moto\\b", "\\media\\b", "^deviazione_standard$", "\\media_armonica\\b" ), collapse = "|")

to_keep <- as.vector( STATS_velocita$classi[-grep(pattern = pattern_to_remove , x = STATS_velocita$classi)])

# remove not neccessary informations for the counts (conteggi totali)
# only keep the "conteggi" by classe 
STATS_velocita <- STATS_velocita %>%
  filter(classi %in% to_keep) 

levels(STATS_velocita$classi) <- gsub("deviazione_standard","STD", levels(STATS_velocita$classi))
levels(STATS_velocita$classi) <- gsub("STD_autotreni","STD_autotreni & artic.", levels(STATS_velocita$classi))
levels(STATS_velocita$classi) <- gsub("media_autotreni","media_autotreni & artic.", levels(STATS_velocita$classi))
levels(STATS_velocita$classi) <- gsub("media_armonica_autotreni","media_armonica_autotreni & artic.", levels(STATS_velocita$classi))

STATS_velocita <- as.data.frame(STATS_velocita)
STATS_velocita$velocita_medie <- round(STATS_velocita$velocita_medie, digits = 0)
STATS_velocita$classi <- as.character(STATS_velocita$classi)

categories <- as.character(unique(STATS_velocita$classi))

### plot velocita' #####
########################

q <- ggplot(data = STATS_velocita, 
            aes(classi, velocita_medie, fill = classi)) +
    theme_bw() +
  
  geom_bar(stat = "identity") + facet_grid(corsia ~ direzione, scales = "free", space = "free") +
  theme(strip.text.x = element_text(size = 13, colour = "black")) +
  guides(fill=FALSE) +
  # scale_fill_manual(values=c("#7f7fff", "#7fbf7f", "#ff0000", "#e5e500", "#8e8e8e")) +
  theme(axis.text.x=element_text(angle=65,hjust=1,vjust=1, size=11)) +
  theme(axis.text.x=element_text(size=10,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                                     
  ylab("velocita' (km/h)") +   
  ylim(0, 130) +
   theme(axis.title.y = element_text(face="bold", colour="black", size=10),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=10, colour="black")) +
  geom_text(aes(label = paste(round(velocita_medie), sep = "")), size = 3, hjust = 0.5, vjust = -0.5) +
  ggtitle("Velocita' per classi (2017-2018)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 15))
q

```


*<br/><br/>*

## 4. Analisi del tempo di occupazione per classe di veicoli

Per l'analisi del tempo di occupazione di ogni corsia del tratto di autostrada A2 in esame, si e' scelto di mostrare il massiimo tempo di occupazione per tipologia di veicolo e per corsia di maarcia. Come si puo' vedere dalla **Figura 12**, nella direzione verso *Salerno*, sulla *Corsia 1*, gli autotreni/articolati hanno regitrato il tempo di occupazione massima, seguito da auto e camion di lungezza maggiore di 7.5m. Invece sulla *Corsia 2*, le auto hanno registrato il tempo massimo di occupazione seguito da autotreni/articolati e furgoni. 
Per quanto riguarda la direzione verso *Avellino*, sulla *Corsia 3*, il tempo massimo di occupazione e' stato registrato da autotreni/articolati seguito da auto e camion di lungezza maggiore di 7.5m. Invece, sulla *Corsia 4* gli autotreni/articolati hanno registrato il tempo massimo di occupazione seguito da auto e furgoni.

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=6,  fig.cap ="**Figura 12.** Massimo tempo di occupazione per classe di autoveicoli e per corsia di marcia sul tratto dell'autostrada A2 (km5+004)."}

########################
### Occupazione  #######
########################


# get all names for speficic classes of velocita'
all_occupazione <- names(DB[grep(pattern  = "occupazione", x = names(DB))])
# remove what the totals
all_occupazione <- all_occupazione[! all_occupazione %in% c("occupazione__sec_", "occupazione__sec__conteggio", "occupazione__sec__altri")]
DB_occupazione <- DB[all_occupazione]


# add corsia and direzione
DB_occupazione <- cbind(DB_occupazione, DB$corsia, DB$direzione)
names(DB_occupazione) <- c(all_occupazione, "corsia", "direzione")
# transpose data
occupazione <- gather(DB_occupazione, "classi", "records", 1:length(all_occupazione))
occupazione$records <- as.numeric(occupazione$records)
occupazione$records <-  round(occupazione$records, digits = 1)
# remove rows with 0 values in the record columns
occupazione <- occupazione[!(occupazione$records == 0), ]

# make "articolati" as the same class of "autotreni"
occupazione$classi <- as.factor(occupazione$classi)
levels(occupazione$classi) <- gsub("__articolati","__autotreni", levels(occupazione$classi))

#media di tutte le velocita' per ogni classe di veicolo di veicoli
occupazione <- occupazione[complete.cases(occupazione), ] # Keep only the complete rows
STATS_occupazione <- occupazione %>%
  group_by(corsia,
           direzione,
           classi) %>%
  summarise(occupazione_media = max(records, na.rm = TRUE)) 

STATS_occupazione$classi <- as.factor(STATS_occupazione$classi)
# change the structure of some strings
levels(STATS_occupazione$classi) <- gsub("occupazione__sec__","", levels(STATS_occupazione$classi))
levels(STATS_occupazione$direzione) <- gsub("A","--> Salerno", levels(STATS_occupazione$direzione))
levels(STATS_occupazione$direzione) <- gsub("D","<-- Avellino", levels(STATS_occupazione$direzione))

levels(STATS_occupazione$classi) <- gsub("\\camion__7_5m\\b","camion < 7.5m", levels(STATS_occupazione$classi))
levels(STATS_occupazione$classi) <- gsub("\\camion__7_5m_1\\b", "camion > 7.5m", levels(STATS_occupazione$classi))

STATS_occupazione$corsia <- as.factor(STATS_occupazione$corsia)
levels(STATS_occupazione$corsia) <- gsub("1","corsia 1", levels(STATS_occupazione$corsia))
levels(STATS_occupazione$corsia) <- gsub("2","corsia 2", levels(STATS_occupazione$corsia))
levels(STATS_occupazione$corsia) <- gsub("3","corsia 3", levels(STATS_occupazione$corsia))
levels(STATS_occupazione$corsia) <- gsub("4","corsia 4", levels(STATS_occupazione$corsia))

levels(STATS_occupazione$classi) <- gsub("autotreni","autotreni & artic.", levels(STATS_occupazione$classi))


# pattern_to_remove = paste(c("\\_conteggio\\b", "\\_altri\\b", "\\_camion__7_5m\\b", "\\_camion__7_5m_1\\b", "\\_auto_rimorchio\\b","\\_autobus\\b", "\\_moto\\b", "\\media\\b", "^deviazione_standard$", "\\media_armonica\\b" ), collapse = "|")
# 
# to_keep <- as.vector( STATS_velocita$classi[-grep(pattern = pattern_to_remove , x = STATS_velocita$classi)])
# 
# # remove not neccessary informations for the counts (conteggi totali)
# # only keep the "conteggi" by classe 
# STATS_velocita <- STATS_velocita %>%
#   filter(classi %in% to_keep) 

STATS_occupazione <- as.data.frame(STATS_occupazione)
STATS_occupazione$occupazione_media <- round(STATS_occupazione$occupazione_media, digits = 0)
STATS_occupazione$classi <- as.character(STATS_occupazione$classi)

categories <- as.character(unique(STATS_occupazione$classi))

### plot OCCUPAZIONE #####
##########################

q <- ggplot(data = STATS_occupazione, 
            aes(classi, occupazione_media, fill = classi)) +
    theme_bw() +
  geom_bar(stat = "identity") + facet_grid(corsia ~ direzione, scales = "free", space = "free") +
  theme(strip.text.x = element_text(size = 13, colour = "black")) +
  guides(fill=FALSE) +
  # scale_fill_manual(values=c("#7f7fff", "#7fbf7f", "#ff0000", "#e5e500", "#8e8e8e")) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1, size=11)) +
  theme(axis.text.x=element_text(size=10,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                                     
  ylab("occupazione (sec)") +   
  ylim(0, 700) +
   theme(axis.title.y = element_text(face="bold", colour="black", size=10),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=10, colour="black")) +
  geom_text(aes(label = paste(round(occupazione_media), sep = "")), size = 3, hjust = 0.5, vjust = -0.5) +
  ggtitle("Massimo tempo di occupazione (in secondi) per classi di autoveicoli (2017-2018)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 15))
q

```

*<br/><br/>*

