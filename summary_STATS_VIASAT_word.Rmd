---
title: "Analisi dati VIASAT A2"
author:
- Federico Karagulian
date: "ultima versione `r format(Sys.time(), '%d %B %Y, %H:%M')`"
output:
  html_document: default
  pdf_document: default
  word_document: 
    reference_docx: word_style_FK.docx
  number_sections: true
  bookdown::word_document: default
---


*<br/><br/>*

## 1. Rete stradale

La sezione stradale sull''autostrada **A2**, lungo il tratto **671 (A2, Km 5+004, Latitudine = 40.7269766666667, Longitudine = 14.7757683333333)** è stato identificato dalla rete OpenStreetMap e convertito in forma di grafo digitale (**Figura 1**). Le coppie di nodi *(32048592, 246509515), (246509515, 1110091820)* verso la direzione **Avellino** e *(1110091823,25844069), (25844069, 25844113)* verso la direzione **Salerno** definiscono gli archi stradali sui quali è stato stimato il numero di passaggi ottenuti dai Floating Car Data (FCD) di Viasat.



```{r, echo=FALSE, fig.cap="**Figura 1**.Postazione Tratto dell'autostrada A2 ottenuta da OpenStreetMap. Archi e nodi sono stati individuati in corrispondezna della postazione ANAS  671 (A2, Km 5+004).", out.width = '70%'}
knitr::include_graphics("D:/ENEA_CAS_WORK/SENTINEL/viasat_data/edges_A2_Salerno.png")
```

*<br/><br/>*


```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 1.**"}



rm(list = ls())

library(RPostgreSQL)
library(lubridate)
library(threadr)
library(stringr)
library(ggplot2)
library(dplyr)
library(openair)
library(pander)
library(ggrepel)
library(grid)
library(gridExtra)
library(broom)
library(tidyr)
library(RColorBrewer)
options(scipen=5)


setwd("D:/ENEA_CAS_WORK/SENTINEL/viasat_data")

data <- read.csv(paste0("FCD_data_speed.csv"),
                                   header = T, sep=",")[-1]
data <- data %>%
  mutate(timedate = ymd_hms(timedate))
data$vehtype <- gsub(1, "car", (data$vehtype))
data$vehtype <- gsub(2, "fleet", (data$vehtype))

data_car <- data %>%
  filter(vehtype == 'car')
data_fleet <- data %>%
  filter(vehtype == 'fleet')


# (32048592, 246509515), (246509515, 1110091820)  --> Avellino
#  (1110091823,25844069), (25844069, 25844113)  <--- Salerno
data$direzione <- as.factor(data$u)
data$direzione <- gsub("25844069", "--> Salerno", (data$direzione))
data$direzione <- gsub("1110091823", "--> Salerno", (data$direzione))
data$direzione <- gsub("32048592", "<-- Avellino", (data$direzione))
data$direzione <- gsub("246509515", "<-- Avellino", (data$direzione))



mapmatching_data <- head(data[, c("direzione", "u","v", "timedate", "name", "ref", "speed", "vehtype")])
names(mapmatching_data) <- c("direzione", "u", "v", "timedate", "nome", "ref", "velocità", "veicolo")


Caption <- paste0("**Tabella 1.** Attributi della rete stradale OpenStreetMap associata alle traccie GPS (Viasat) di veicoli in movimento sull'autostrada A2.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(mapmatching_data, emphasize.strong.cols = 1, missing = "")

```


*<br/><br/>*

## 2. Dati Viasat


I dati Viasat sono caratterizzati dalla presenza di un identificativo anonimo del veicolo **idterm**, di un *orario* (**timedate**),  della distanza progressiva percorsa da ogni veicolo (**progressive**), dal un segnale *on/off* (**panel**) che indica se il motore è acceso o spento. Infine, viene anche riportata l'*accuratezza* del dato GPS (**grade**) il cui valore varia da *1* (piu' accurato) a *50* (meno accurato). 

Abbiamo analizzato una serie temporale di FCD Viasat per il periodo 1-18 Settembre 2017. Questo periodo coincide con quello in cui abbiamo a disposizione delle osservazioni di traffico effettuate da ANAS sulla stessa sezione stradale. E' quindi stato possibile fare un confronto. Per il periodo 1-18 Settembre 2018 abbiamo registrato un numero di **`r length(unique(data$idterm))`** veicoli che sono passati sulla sezione in esame dell'autostrada A2. Di questi veicoli, **`r length(unique(data_car$idterm))`** sono stati identificati come **automobili**, mentre **`r length(unique(data_fleet$idterm))`** sono stati identificati come **flotta** includendo anche veicoli pesanti (**Figura 2**). Quindi i veicoli di flotta rappresentanto circa il **17%** del dataset di dati. 


## 3. Map-matching e conteggio di passaggi

Per stabilire su quale arco un veicolo (FCD data) è transitato, abbiamo sviluppato un algoritmo di *map-matching*. L'algoritmo consiste nell'analisi di tutte le tracce GPS per singolo veicolo e dell'individuazione dei suoi viaggi in un determinato periodo temporale. Per ogni viaggio, che corrisponde ad una sequenza di traccie GPS, l'algoritmo ha individuato una possibile sequenza di nodi, e quindi di archi percorsi. 
** Tabella 1** mostra una parte rilevante dell'output di map-matching con l'indicazione del nodo di origine **u** e del nodo di destinazione **v** per ogni arco stradale ed ogni orario (**timedate**) in cui l'arco viene percorso. L'ordine dei nodi permette inoltre di determinare la direzione di marcia di ogni traccia. Infine, e' stato riportato il tipo di veicolo (automobile o flotta) da cui e' anche possible determinare la sua portata massima. Ogni coppia di nodi rappresenta il passaggio di un veicolo sopra un determianto arco. Il conteggio totale dei passaggi per tipo di veicolo e direzione di marcia si ottiene sommando il numero di volte che un arco viene attraverstato nell'intervallo temporale complessivo. 



```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap = "**Tabella 2.**"}


direzione <- data[, c("direzione", "u", "idterm", "speed")]

total_counts_direzione <- direzione %>%
    group_by(direzione) %>%
    summarize(instant_speed=mean(speed),
              count_VIASAT = length(idterm))
## add ANAS count
total_counts_direzione$count_ANAS <- c(872403, 834415)
total_counts_direzione$`%_VIASAT` <- (total_counts_direzione$count_VIASAT/total_counts_direzione$count_ANAS)*100
names(total_counts_direzione) <- c("direzione",  "velocità", "passaggi VIASAT", "passaggi ANAS", "%(VIASAT/ANAS)")
total_counts_direzione$`%(VIASAT/ANAS)` <- round(total_counts_direzione$`%(VIASAT/ANAS)`, digits = 2)

Caption <- paste0("**Tabella 2.** Numero totale di passaggi di autoveicoli sul tratto dell'autostrada A2 tra il 31/08/2017 ed il 18/09/2017. Confronto con dati ANAS per lo stesso periodo temporale.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(total_counts_direzione, emphasize.strong.cols = 1, missing = "")


```

Mentre le osservazioni ANAS sono riferite a conteggi in tempo reale di tutti i veicoli,i dati Viasat rappresentano solo una piccola frazione dei veicoli transitati sulla sezione stradale in esame.  
Come ripotato in **Tabella 3**, il mumero totale di passaggi di dati Viasat rappresenta circa il **3%** dei dati ANAS su entrambe le direzioni di marcia.

*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 2.** Numero di passaggi totali per classe di autoveicoli sul tratto dell'autostrada A2 (km5+004). I numeri all'interno del grafico indicano la distribuzione percentuale per classi di veicolo del numero di passaggi sulle due direzioni di marcia: --> Salerno e <-- Avellino."}


direzione <- data[, c("direzione", "u", "idterm", "vehtype")]

total_counts_type_direzione <- direzione %>%
    group_by(direzione,
             vehtype) %>%
    summarize(count_VIASAT = length(idterm))

total_counts_type_direzione <- total_counts_type_direzione %>%
  left_join(total_counts_direzione, by = c("direzione"))

total_counts_type_direzione <- total_counts_type_direzione %>%
  mutate(norm_conteggi = (count_VIASAT)/(`passaggi VIASAT`)*100)
total_counts_type_direzione$norm_conteggi <- round(total_counts_type_direzione$norm_conteggi, digits = 0)

categories <- as.character( unique(total_counts_type_direzione$vehtype))

### plot passaggi #####
#######################

q <- ggplot(data = total_counts_type_direzione,
            aes(vehtype, count_VIASAT, fill = direzione)) +
  theme_bw() +
  geom_bar(stat = "identity", position = position_stack()) +
  scale_x_discrete(limits = categories) +
  geom_text_repel(aes(label=norm_conteggi), vjust=1, color="black",
            position = position_stack(0.8), size=5)+
  theme(legend.text = element_text(colour="black", size = 11, face = "bold")) +
  theme(axis.title.x = element_blank()) +
  ylab(expression(paste("numero di passaggi (a.u)"))) +
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=12, colour="black")) +
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=1, ,hjust=1, size=14, face="bold")) +
  ggtitle("Numero di passaggi totali (1-18 Settembre 2017)") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13, hjust=0.5))
q

````

*<br/><br/>*

L'andamento del numero di passaggi per giorno della settimana e per tipo di veicolo è riportato in **Figura 3**. Per i veicoli di flotta, i dati Viasat mostrano che i giorni di Sabato e Domenica sono quelli con il minore numero di passaggi. Questo risultato è in linea con i conteggi totali di mezzi pesanti osservato per i dati ANAS. Tuttavia, per le automobili, non è stato osservato lo stesso trend temporale tra i dati Viasat ed i dati ANAS. Questo significa che i dati Viasat di flotta sono più rappresentativi dei dati Viasat delle automobili se usati come alternativa ai dati ANAS. Tuttavia il trend orario del numero di passaggi (**Figura 4**) rivela che i veicoli analizzati seguono l'andamento tipico di una giornata lavorativa con un mumero elevato di passaggi verso le 09:00 e verso le 18:00-19:00. Questi passaggi sono probabilmente associati a viaggi casa-lavoro che vengono effettuati giornalmente.  


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 3.** Numero di passaggi totali per giorno della settimana e per classe di autoveicoli su un tratto dell'autostrada A2 (Salerno-Avellino). I numeri all'interno del grafico indicano la distribuzione percentuale per classi di veicolo del numero di passaggi."}

###############################
### summary stats by day ######
###############################


## get the months of observations
data$month <- format(data$timedate, format = "%b")

## get the DAY and HOUR (of the week) of observations
data <- data %>%
  mutate(day = wday(timedate, label=TRUE)) %>%
  mutate(hour = hour(timedate))
data$day <- as.factor((data$day))
data$hour <- as.factor((data$hour))


## get all passaggi (conteggi) by hour
VIASAT_STATS_passaggi_daily <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype, day, hour) %>%
    summarize(instant_speed=mean(speed),
              count = length(idterm))


all_vehtype <- VIASAT_STATS_passaggi_daily %>%
  group_by(direzione,
           day) %>%
  summarise(conteggi_totali = sum(count, na.rm = TRUE))


# somma di tutti i tipi di conteggi per i passaggi di veicoli
VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  group_by(direzione,
           vehtype,
           day) %>%
  summarise(conteggi_per_tipo = sum(count, na.rm = TRUE))
VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
  left_join(all_vehtype, by = c("direzione", "day"))

VIASAT_STATS_passaggi_daily <- as.data.frame(VIASAT_STATS_passaggi_daily)
## get number all all vehicles by pecentage
# normalize all "passaggi" to the conteggi_totali
VIASAT_STATS_passaggi_daily$norm_conteggi <- (VIASAT_STATS_passaggi_daily$conteggi_per_tipo/VIASAT_STATS_passaggi_daily$conteggi_totali)*100

  # mutate(norm_conteggi = (conteggi_per_tipo/conteggi_totali)*100)


# VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily %>%
#   group_by(direzione,
#            day) %>%
#   mutate(norm_conteggi = (conteggi_per_tipo/conteggi_totali)*100)
VIASAT_STATS_passaggi_daily$norm_conteggi <- round(VIASAT_STATS_passaggi_daily$norm_conteggi, digits = 0)


VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily[order(-VIASAT_STATS_passaggi_daily$conteggi_totali),]
VIASAT_STATS_passaggi_daily <- VIASAT_STATS_passaggi_daily[order(-VIASAT_STATS_passaggi_daily$norm_conteggi),]


VIASAT_STATS_passaggi_daily <- as.data.frame(VIASAT_STATS_passaggi_daily)
# VIASAT_STATS_passaggi_daily$classi <- as.character(VIASAT_STATS_passaggi_daily$classi)

categories <- as.character( unique(VIASAT_STATS_passaggi_daily$vehtype))

### plot passaggi by % pecentage and by DAY #####
###################################################

# STATS_passaggi_daily_SALERNO <- VIASAT_STATS_passaggi_daily %>%
#    filter(direzione == "--> Salerno") 

p <- ggplot(data = VIASAT_STATS_passaggi_daily,
              aes(day, conteggi_per_tipo, fill = day)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    # facet_wrap( ~ vehtype, ncol = 4) +
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    ylim(0, 6000) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=11)) +
    xlab("giorno settimana") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=45, vjust=1, size=12)) +
    geom_text(aes(label = paste(norm_conteggi, sep = "")), size = 4, hjust = 0.5,  vjust = -0.5) +
    ggtitle("Numero totale di passaggi per giorno della settimana (1-18 Settembre 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```


*<br/><br/>*
*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 4.** Numero di passaggi totali per ora della settimana e per classe di autoveicoli su un tratto dell'autostrada A2 (Salerno-Avellino)."}

################################
### summary stats by hour ######
################################

## get all passaggi (conteggi) by hour
VIASAT_STATS_passaggi_hourly <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype, day, hour) %>%
    summarize(instant_speed=mean(speed),
              count = length(idterm))

VIASAT_STATS_passaggi_hourly$vehtype <- as.factor(VIASAT_STATS_passaggi_hourly$vehtype)

VIASAT_STATS_passaggi_hourly <- VIASAT_STATS_passaggi_hourly %>%
  group_by(direzione,
           vehtype,
           hour) %>%
  summarise(conteggi_totali = sum(count, na.rm = TRUE))

VIASAT_STATS_passaggi_hourly <- as.data.frame(VIASAT_STATS_passaggi_hourly)
 
VIASAT_STATS_passaggi_hourly <- VIASAT_STATS_passaggi_hourly[order(-VIASAT_STATS_passaggi_hourly$conteggi_totali),]

VIASAT_STATS_passaggi_hourly$hour <- as.numeric(VIASAT_STATS_passaggi_hourly$hour)

#### plot

# VIASAT_STATS_passaggi_hourly_SALERNO <- VIASAT_STATS_passaggi_hourly %>%
#    filter(direzione == "--> Salerno") 

p <- ggplot(data = VIASAT_STATS_passaggi_hourly,
              aes(hour, conteggi_totali, fill = hour)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    # facet_wrap( ~ vehtype, ncol = 4) +  
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +
    guides(fill=FALSE) +
    # ylim(0, 1100000) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("ora nella giornata") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    ggtitle("Numero totale di passaggi per ora della giornata (1-18 Settembre 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```


*<br/><br/>*

## 4. Distribuzione delle velocità

La distribuzione delle velocità istantanee dei veicoli è rappresentata in **Figura 6**. Per entrambe le tipologie di veicoli (automobili e flotta) si e' cercato di modelizzare le distribuzioni con una curva Gaussiana.  


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 5.** Distribuzione delle velocita' istantanee per classe di autoveicoli su un tratto dell'autostrada A2 (1-18 Settembre 2017; Salerno-Avellino)"}


plots <- lapply(split(data, data$vehtype),FUN=function(speed_dist){ 
    # ggplot(aes((speed), fill = as.factor(vehtype))) +
    ggplot(speed_dist, aes(speed)) +
    # ggplot(aes( (mean_speed))) + 
    geom_density(alpha = 0.5) +
    ylim(0, 0.035) +
    # geom_histogram(binwidth=.05) +   ### counts
    stat_function(fun = dnorm, 
                  args = list(mean = mean(speed_dist$speed),
                           sd = sd(speed_dist$speed)), colour = "red") +  ## fit withGaussian
    theme_bw() +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
          axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
    ylab("densità (u.a)") +
    xlab("velocità (km/h)") +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
    geom_vline(xintercept=mean(speed_dist$speed), color="red", linetype="dashed", size=0.5) 
})


# Finally, present the plots on 3 columns.
grid.arrange(plots$car, plots$fleet, nrow=1, ncol = 2,
             top = textGrob("car                                                  fleet",gp=gpar(fontsize=20,font=3)))

````


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 5a.** "}



# estimate paramters
library(MASS)
library(fitdistrplus)
data_car <- data %>%
  filter(vehtype == "car")
data_fleet <- data %>%
  filter(vehtype == "fleet")
## fit with a "gaussian/normal" distribution
fit_cars <- fitdistrplus::fitdist(data_car$speed, "norm")
class(fit_cars) <- c("fitdist", "fitdistr") 
fit_cars <- as.data.frame(broom::tidy(fit_cars))
names(fit_cars) <- c("term", "car", "car_error" )

fit_fleets  <- fitdistrplus::fitdist(data_fleet$speed, "norm")
class(fit_fleets) <- c("fitdist", "fitdistr") 
fit_fleets <- as.data.frame(broom::tidy(fit_fleets))
names(fit_fleets) <- c("term", "fleet", "fleet_error" )
## plot
# denscomp(ft = fit_cars, legendtext = "Normal")
# denscomp(ft = fit_fleets, legendtext = "Normal")

cars <- gather(fit_cars,  "tipo veicolo", "velocità", 2:length(fit_cars)) 
fleets <- gather(fit_fleets, "tipo veicolo", "velocità", 2:length(fit_fleets)) 
car_fleets <- rbind(cars, fleets)
car_fleets <- car_fleets %>%
  filter(`tipo veicolo` %in% c("car", "fleet"))
car_fleets$`velocità` <- round(car_fleets$`velocità`, digits = 2)
names(car_fleets) <- c("", "tipo veicolo", "velocità")

Caption <- paste0("**Tabella 3.** Parametri ottenuti dalla modellizzazione della distribuzione delle **velocità instantanee** con una distribuzione gaussiana. Sono stati confrontati dati ANAS e FCD di Viasat per il periodo 1-18 Settembre 2017. I parametri di valore medio e di deviazione standard sono riportati per automobli e veicoli pesanti.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(car_fleets, emphasize.strong.cols = 1, missing = "")

````


*<br/><br/>*


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Tabella 3a.**"}



# estimate paramters
library(MASS)
library(fitdistrplus)
## fit with a "gaussian/normal" distribution
fit_VIASAT <- fitdistrplus::fitdist(data$speed, "norm")
class(fit_VIASAT) <- c("fitdist", "fitdistr") 
fit_VIASAT <- as.data.frame(broom::tidy(fit_VIASAT))
names(fit_VIASAT) <- c("term", "veicoli VIASAT", "car_error" )


fit_VIASAT <- gather(fit_VIASAT,  "tipo veicolo", "velocità", 2:length(fit_VIASAT)) 
fit_VIASAT <- fit_VIASAT %>%
  filter(`tipo veicolo` %in% c("veicoli VIASAT"))
fit_VIASAT$`velocità` <- round(fit_VIASAT$`velocità`, digits = 2)



### load ANAS data ####
velocita_ANAS <-  read.csv(paste0("D:/ENEA_CAS_WORK/SENTINEL/ANAS/velocita_ANAS.csv"),
         header = T, sep=",")[-1]


names(velocita_ANAS)[names(velocita_ANAS) == 'velocità'] <- 'speed'

AAA <- data.frame(observation = "ANAS", velocità = velocita_ANAS$speed)
BBB <- data.frame(observation = "VIASAT", velocità = data$speed)
ZZZ <- rbind(AAA, BBB)
colorData <- brewer.pal(length(unique(ZZZ$observation)), "Set1")
# Replace first color first wanted grey
colorData[1] <- "red"
colors <- c(
  "ANAS" = "red",
  "VIASAT" = "blue"
)



p <- ggplot(data =velocita_ANAS,  aes((x=speed))) +
    geom_density(alpha = 0.5, size=2, colour = "red") +
    geom_density(data = data, size=2, colour = "blue") +
    geom_density(aes(velocità, colour=factor(observation)), size=2, data=ZZZ) +
    scale_color_manual(values = colorData, name = "") +
    stat_function(fun = dnorm, args = list(mean = mean(velocita_ANAS$speed),
                                           sd = sd(velocita_ANAS$speed)), colour = "red") + 
    stat_function(fun = dnorm, args = list(mean = mean(data$speed),
                                           sd = sd(data$speed)), colour = "blue") +
    # scale_x_continuous(trans='log10') +
    guides(fill=guide_legend(title="tipo veicolo")) +
    theme_bw() +
    theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
          axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
    ylab("densità (u.a)") +
    # ylab("conteggi") +
    xlab("velocità (km/h)") +
    theme(axis.title.y = element_text(face="bold", colour="black", size=13),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
   geom_vline(xintercept=mean(  velocita_ANAS$speed), color="red", linetype="dashed",
              size=0.5) +
   geom_vline(xintercept=mean(  data$speed), color="blue", linetype="dashed",
              size=0.5) +
    ggtitle("Distribuzione delle velocità istantanee (ANAS & VIASAT; 1-18 Settembre 2017)") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
p

```



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Tabella 3a.**"}


## fit with a "gaussian/normal" distribution
fit_ANAS <- fitdistrplus::fitdist(velocita_ANAS$speed, "norm")
class(fit_ANAS) <- c("fitdist", "fitdistr") 
fit_ANAS <- as.data.frame(broom::tidy(fit_ANAS))
names(fit_ANAS) <- c("term", "veicoli ANAS", "errore ANAS" )

fit_ANAS <- gather(fit_ANAS,  "tipo veicolo", "velocità", 2:length(fit_ANAS)) 
fit_ANAS <- fit_ANAS %>%
  filter(`tipo veicolo` == "veicoli ANAS")

fit_ANAS$`velocità` <- round(fit_ANAS$`velocità`, digits = 2)
### combine the data in an unique dataframe
all_fits <- rbind(fit_ANAS, fit_VIASAT)
names(all_fits) <- c("", "source data", "velocità")



Caption <- paste0("**Tabella 3a.** Parametri ottenuti dalla modellizzazione della distribuzione delle **velocità instantanee**con una distribuzione *gaussiana*. Sono stati confrontati dati ANAS e FCD di Viasat per il periodo 1-18 Settembre 2017. I parametri di valore medio e di deviazione standard sono riportati per tutti gli autoveicoli")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(all_fits, emphasize.strong.cols = 1, missing = "")

````



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 6.** Velocità media istantanea per giorno della settimana e per classe di autoveicoli su un tratto dell'autostrada A2 (1-18 Settembre 2017; Salerno-Avellino)."}

###############################
### summary stats by day ######
###############################

## get all passaggi (conteggi) by hour
VIASAT_speed_STATS_daily <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype, day, hour) %>%
    summarize(instant_speed=mean(speed),
              count = length(idterm))

# somma di tutti i tipi di conteggi per i passaggi di veicoli
VIASAT_speed_daily <- VIASAT_speed_STATS_daily %>%
  group_by(direzione,
           vehtype,
           day) %>%
  summarise(velocita_per_tipo = mean(instant_speed, na.rm = TRUE))


VIASAT_speed_daily <- as.data.frame(VIASAT_speed_daily)
VIASAT_speed_daily <- VIASAT_speed_daily[order(-VIASAT_speed_daily$velocita_per_tipo),]

categories <- as.character( unique(VIASAT_speed_daily$vehtype))

### plot velocita' instantanea by DAY #####
###########################################

p <- ggplot(data = VIASAT_speed_daily,
              aes(day, velocita_per_tipo, fill = vehtype)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
  # facet_wrap( ~ vehtype, ncol = 4) +
  facet_grid(direzione ~ vehtype, scales = "free", space = "free") +  
    guides(fill=FALSE) +
    ylim(0, 100) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("velocità (km/h)") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=11)) +
    xlab("giorno settimana") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=45, vjust=1, size=12)) +
    geom_hline(yintercept=90, color="red", linetype="dashed", size=0.5) +
    ggtitle("Velocità media istantanea per giorno della settimana (1-18 Settembre 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```


*<br/><br/>*



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 6a.** Velocità media istantanea per ora della giornata e per classe di autoveicoli su un tratto dell'autostrada A2 (1-18 Settembre 2017; Salerno-Avellino)."}

################################
### summary stats by hour ######
################################

## get all passaggi (conteggi) by hour
VIASAT_speed_STATS_hourly <- data %>%
    group_by(Date=floor_date(timedate, "1 hour"), direzione, vehtype, day, hour) %>%
    summarize(instant_speed=mean(speed),
              count = length(idterm))

VIASAT_speed_STATS_hourly <- VIASAT_speed_STATS_hourly %>%
  group_by(direzione,
           vehtype,
           hour) %>%
  summarise(velocita_per_tipo = mean(instant_speed, na.rm = TRUE))

VIASAT_speed_STATS_hourly <- as.data.frame(VIASAT_speed_STATS_hourly)
 
VIASAT_speed_STATS_hourly <- VIASAT_speed_STATS_hourly[order(-VIASAT_speed_STATS_hourly$velocita_per_tipo),]

VIASAT_speed_STATS_hourly$hour <- as.numeric(VIASAT_speed_STATS_hourly$hour)


################
#### plot ######
################
 

p <- ggplot(data = VIASAT_speed_STATS_hourly,
              aes(hour, velocita_per_tipo, fill = hour)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") + 
    facet_grid(direzione ~ vehtype, scales = "free", space = "free") +   
    guides(fill=FALSE) +
    ylim(0, 120) +
    theme_bw() +
    theme( strip.text = element_text(size = 13)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("numero di passaggi") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("ora nella giornata") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=12, hjust = 0.5)) + 
    theme(axis.title.y = element_text(face="bold", colour="black", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    scale_x_continuous(breaks=c(0, 5, 10, 15, 20)) +
    geom_hline(yintercept=100, color="red", linetype="dashed", size=0.5) +
    ggtitle("Velocità media istantanea per ora della giornata (1-18 Settembre 2017)") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p


```


*<br/><br/>*


